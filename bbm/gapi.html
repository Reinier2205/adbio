<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grounded Morning Briefing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            min-height: 100vh;
        }
        .briefing-output {
            white-space: pre-wrap;
            background-color: #ffffff;
            border-left: 4px solid #3b82f6; /* Blue border for emphasis */
        }
        .source-link {
            word-break: break-all;
        }
    </style>
</head>
<body class="p-4">

    <div class="container mx-auto max-w-4xl pt-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">AI-Powered Morning Briefing</h1>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <p class="text-sm text-gray-600 mb-4">This demonstration uses the Gemini API with **Google Search grounding** to ensure the news, sports fixtures, and weather data are current.</p>

            <button id="generateButton" 
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-150 ease-in-out shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                Generate Briefing
            </button>
            <p id="loadingIndicator" class="text-center text-blue-500 mt-4 hidden">Generating briefing, please wait...</p>
        </div>

        <div id="briefingContainer" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Generated Briefing:</h2>
            
            <div id="briefingOutput" class="briefing-output p-5 rounded-lg shadow-inner mb-6 text-gray-700">
                <!-- Briefing content will be inserted here -->
            </div>

            <div id="citations" class="p-4 bg-gray-100 rounded-lg text-sm text-gray-700">
                <h3 class="font-semibold mb-2 text-gray-800">Grounding Sources (Citations):</h3>
                <ul id="sourceList" class="space-y-1">
                    <!-- Sources will be inserted here -->
                </ul>
            </div>
        </div>

        <div id="errorBox" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg mt-8 hidden" role="alert">
            <p class="font-bold">Error:</p>
            <p id="errorMessage"></p>
        </div>

    </div>

    <script type="module">
        // Global environment variables (provided by the Canvas environment, but defined as empty string here)
        const apiKey = "";
        
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const briefingContainer = document.getElementById('briefingContainer');
        const briefingOutput = document.getElementById('briefingOutput');
        const sourceList = document.getElementById('sourceList');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        // --- Core Gemini API Logic ---

        // The specific instruction set for the model's persona and output format
        const systemPrompt = "You are a professional News Briefing Generator. Your response must be formatted clearly into 'Headlines', 'Sports Fixtures', and 'Weather Forecast' sections. Use a professional, direct, and informative tone. Do not include any news about celebrity gossip or sports results. For the weather, use the location 'Sandton, Gauteng, South Africa'.";
        
        // The detailed task based on the user's previous request
        const userQuery = "Provide a morning briefing covering the top headlines in world news, technology, and the economy. Then, provide a concise summary of upcoming national and provincial Rugby Union and Cricket games in South Africa, as well as international fixtures in both sports. Conclude with the detailed weather forecast for the user's location.";
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility to handle retries for API calls
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Throw error to trigger retry or final catch
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Re-throw if it's the last attempt
                    }
                    // Exponential backoff
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        async function callGeminiAPI() {
            // Reset UI
            briefingContainer.classList.add('hidden');
            errorBox.classList.add('hidden');
            briefingOutput.textContent = '';
            sourceList.innerHTML = '';
            
            generateButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    
                    // CRITICAL: Include the tools property to enable Google Search grounding
                    tools: [{ "google_search": {} }], 
                    
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // Extract grounding sources (citations)
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); // Ensure sources are valid
                    }

                    // Display the generated text
                    briefingOutput.textContent = text;
                    briefingContainer.classList.remove('hidden');

                    // Display the sources
                    if (sources.length > 0) {
                        sources.forEach((source, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <strong>${index + 1}.</strong> 
                                <a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 underline source-link">
                                    ${source.title || 'Source Link'}
                                </a>
                            `;
                            sourceList.appendChild(li);
                        });
                    } else {
                        sourceList.innerHTML = '<li>No grounding sources were found for this generation.</li>';
                    }

                } else {
                    errorMessage.textContent = 'API response did not contain valid content.';
                    errorBox.classList.remove('hidden');
                }

            } catch (error) {
                console.error("API Call failed:", error);
                errorMessage.textContent = `A communication error occurred: ${error.message}.`;
                errorBox.classList.remove('hidden');
            } finally {
                generateButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        // Attach event listener
        generateButton.addEventListener('click', callGeminiAPI);
    </script>
</body>
</html>

