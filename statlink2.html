<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Starlink — 12h Visibility (10-min steps)</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root { --bg:#0d1117; --panel:#161b22; --muted:#9ca3af; --accent:#22c55e; --text:#c9d1d9; --status:#9cd6ff; }
  html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
  .wrap { max-width:1000px; margin:1.5rem auto; padding:1rem; }
  .panel { background:var(--panel); border:1px solid #30363d; border-radius:10px; padding:1rem; }
  h1 { color:var(--accent); margin:0 0 0.75rem 0; font-size:1.2rem; }
  .controls { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
  button { background:#16a34a; color:#fff; border:0; padding:0.5rem 0.9rem; border-radius:8px; cursor:pointer; font-weight:600; }
  .small-btn { background:#0b5; padding:0.4rem 0.6rem; font-size:0.9rem; border-radius:6px; }
  .loc { font-family:monospace; color:var(--muted); font-size:0.95rem; }
  #status { margin-top:0.75rem; color:var(--status); font-size:0.95rem; }
  pre { margin-top:1rem; background:#0b0f14; border:1px solid #22272b; padding:1rem; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; color:var(--text); }
  table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.95rem; }
  th, td { border:1px solid #30363d; padding:8px; text-align:left; vertical-align:middle; }
  th { background:#21262d; color:var(--status); }
  .center { text-align:center; }
  .coord { font-family:monospace; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Starlink — 12h Visibility (10-minute steps)</h1>

      <div class="controls">
        <button id="fetchBtn">Fetch TLEs & Analyze</button>
        <div class="loc" id="locDisplay">Lat: —  Lon: —  (time: —)</div>
        <button id="getLocBtn" class="small-btn">Get Location</button>
      </div>

      <div id="status">Idle.</div>

      <table id="summaryTable" style="display:none;">
        <thead>
          <tr>
            <th class="center">Total Satellites (TLEs)</th>
            <th class="center">Satellites Visible (next 12h)</th>
            <th class="center">Time Resolution</th>
            <th class="center">Analysis Time</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="totalCount" class="center">0</td>
            <td id="visibleCount" class="center">0</td>
            <td id="resolution" class="center">—</td>
            <td id="analysisTime" class="center">—</td>
          </tr>
        </tbody>
      </table>

      <table id="visibleTable" style="display:none;">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>First Visible (local)</th>
            <th>Max Elevation (°)</th>
            <th>Satellite Lat/Lon</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="visibleBody"></tbody>
      </table>

      <pre id="output">Raw TLE output will appear here after fetch.</pre>
    </div>
  </div>

<script src="https://unpkg.com/satellite.js@4.0.2/dist/satellite.min.js"></script>

<script>
const WORKER_URL = "https://starlink-tle.reinier-olivier.workers.dev/";
const DISPLAY_STEP_MINUTES = 10;
const ANALYSIS_STEP_MINUTES = 1; // For accurate detection
const HOURS = 12;
const DEG2RAD = Math.PI / 180;
const RAD2DEG = 180 / Math.PI;

const fetchBtn = document.getElementById('fetchBtn');
const getLocBtn = document.getElementById('getLocBtn');
const locDisplay = document.getElementById('locDisplay');
const statusEl = document.getElementById('status');
const outputEl = document.getElementById('output');
const summaryTable = document.getElementById('summaryTable');
const totalCountEl = document.getElementById('totalCount');
const visibleCountEl = document.getElementById('visibleCount');
const resolutionEl = document.getElementById('resolution');
const analysisTimeEl = document.getElementById('analysisTime');
const visibleTable = document.getElementById('visibleTable');
const visibleBody = document.getElementById('visibleBody');

let currentLat = null;
let currentLon = null;
let locTimestamp = null;

function fmtNum(n, d=6){ return (typeof n === 'number' && isFinite(n)) ? n.toFixed(d) : '—'; }
function fmtLocal(ts){ return ts ? new Date(ts).toLocaleString() : '—'; }
function updateLocUI(){ locDisplay.textContent = `Lat: ${fmtNum(currentLat,4)}  Lon: ${fmtNum(currentLon,4)}  (time: ${fmtLocal(locTimestamp)})`; }

function requestLocation(){
  if (!navigator.geolocation){ locDisplay.textContent = 'Location API not available'; return; }
  locDisplay.textContent = 'Requesting location...';
  navigator.geolocation.getCurrentPosition(pos => {
    currentLat = pos.coords.latitude;
    currentLon = pos.coords.longitude;
    locTimestamp = pos.timestamp || Date.now();
    updateLocUI();
  }, err => {
    locDisplay.textContent = 'Location error: ' + (err.message || 'unknown');
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:30000 });
}

function parseTLEs(raw){
  const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
  const sats = [];
  for (let i = 0; i < lines.length - 2; i++) {
    if (lines[i+1].startsWith("1 ") && lines[i+2].startsWith("2 ")) {
      sats.push({ name: lines[i].replace("STARLINK-",""), line1: lines[i+1], line2: lines[i+2] });
      i += 2;
    }
  }
  return sats;
}

async function analyzeTLEs(rawText){
  const t0 = performance.now();
  const sats = parseTLEs(rawText);
  totalCountEl.textContent = sats.length;
  if (sats.length === 0) {
    statusEl.textContent = "No TLEs found.";
    return;
  }

  statusEl.textContent = `Analyzing ${sats.length} satellites...`;
  resolutionEl.textContent = `${DISPLAY_STEP_MINUTES}-min steps (analyzed at ${ANALYSIS_STEP_MINUTES}-min)`;

  const now = new Date();
  const end = new Date(now.getTime() + HOURS * 3600 * 1000);
  const stepMs = ANALYSIS_STEP_MINUTES * 60 * 1000;

  const observerGd = {
    latitude: (currentLat ?? 0) * DEG2RAD,
    longitude: (currentLon ?? 0) * DEG2RAD,
    height: 0
  };

  const visibleResults = [];

  for (let si = 0; si < sats.length; si++){
    const s = sats[si];
    let satrec;
    try { satrec = satellite.twoline2satrec(s.line1, s.line2); } catch { continue; }

    let visible = false;
    let firstVisible = null;
    let maxElev = -Infinity;
    let maxElevTime = null;

    for (let t = now.getTime(); t <= end.getTime(); t += stepMs) {
      const date = new Date(t);
      try {
        const pv = satellite.propagate(satrec, date);
        if (!pv.position) continue;
        const gmst = satellite.gstime(date);
        const positionEcf = satellite.eciToEcf(pv.position, gmst);
        const lookAngles = satellite.ecfToLookAngles(observerGd, positionEcf);
        const elev = lookAngles.elevation * RAD2DEG;
        if (elev > 0 && !visible) { visible = true; firstVisible = date.getTime(); }
        if (elev > maxElev) { maxElev = elev; maxElevTime = date; }
      } catch { continue; }
    }

    if (visible && maxElevTime) {
      let satLat = null, satLon = null;
      try {
        const pvMax = satellite.propagate(satrec, maxElevTime);
        if (pvMax.position) {
          const gmstMax = satellite.gstime(maxElevTime);
          const geodetic = satellite.eciToGeodetic(pvMax.position, gmstMax);
          satLat = geodetic.latitude * RAD2DEG;
          satLon = geodetic.longitude * RAD2DEG;
          if (satLon > 180) satLon -= 360;
          else if (satLon < -180) satLon += 360;
        }
      } catch (e) {
        // Coordinate calculation failed; leave as null (should be rare)
      }

      visibleResults.push({
        name: s.name,
        firstVisible,
        maxElevation: maxElev,
        satLat,
        satLon
      });
    }

    if (si % 50 === 0) await new Promise(r => setTimeout(r, 0));
  }

  // Sort by date/time first, then by max elevation ascending
  visibleResults.sort((a, b) => {
    if (a.firstVisible !== b.firstVisible) {
      return a.firstVisible - b.firstVisible;
    }
    return a.maxElevation - b.maxElevation;
  });

  visibleBody.innerHTML = "";
  for (const v of visibleResults) {
    const tr = document.createElement("tr");
    const firstLocal = fmtLocal(v.firstVisible);
    const coordText = (v.satLat !== null && v.satLon !== null)
      ? `${fmtNum(v.satLat, 4)}, ${fmtNum(v.satLon, 4)}`
      : "—";
    const note = v.maxElevation > 30 ? "Good pass" :
                 v.maxElevation > 10 ? "Low pass" : "Near horizon";
    tr.innerHTML = `
      <td>${v.name}</td>
      <td>${firstLocal}</td>
      <td>${v.maxElevation.toFixed(1)}</td>
      <td class="coord">${coordText}</td>
      <td>${note}</td>
    `;
    visibleBody.appendChild(tr);
  }

  visibleCountEl.textContent = visibleResults.length;
  summaryTable.style.display = "table";
  visibleTable.style.display = visibleResults.length ? "table" : "none";

  const t1 = performance.now();
  analysisTimeEl.textContent = `${Math.round(t1 - t0)} ms`;
  statusEl.textContent = `Done. ${visibleResults.length} visible in next ${HOURS}h.`;
}

async function fetchAndAnalyze(){
  outputEl.textContent = '';
  visibleBody.innerHTML = '';
  summaryTable.style.display = 'none';
  visibleTable.style.display = 'none';
  statusEl.textContent = 'Fetching TLEs...';
  try {
    const res = await fetch(WORKER_URL, { cache:"no-store" });
    const text = await res.text();
    outputEl.textContent = text || '[No data]';
    await analyzeTLEs(text);
  } catch (e) {
    outputEl.textContent = `Error: ${e.message}`;
    statusEl.textContent = `Error fetching data.`;
  }
}

fetchBtn.addEventListener('click', fetchAndAnalyze);
getLocBtn.addEventListener('click', requestLocation);
window.addEventListener('load', requestLocation);
</script>
</body>
</html>