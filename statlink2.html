<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Starlink — Debug Mode</title>
<style>
  :root { --bg:#0d1117; --panel:#161b22; --muted:#9ca3af; --accent:#22c55e; --text:#c9d1d9; --status:#9cd6ff; }
  html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
  .wrap { max-width:1000px; margin:1.5rem auto; padding:1rem; }
  .panel { background:var(--panel); border:1px solid #30363d; border-radius:10px; padding:1rem; }
  h1 { color:var(--accent); margin:0 0 0.75rem 0; font-size:1.2rem; }
  .controls { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
  button { background:#16a34a; color:#fff; border:0; padding:0.5rem 0.9rem; border-radius:8px; cursor:pointer; font-weight:600; }
  .loc { font-family:monospace; color:var(--muted); font-size:0.95rem; }
  #status { margin-top:0.75rem; color:var(--status); font-size:0.95rem; }
  pre { margin-top:1rem; background:#0b0f14; border:1px solid #22272b; padding:1rem; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; color:var(--text); }
  table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.95rem; }
  th, td { border:1px solid #30363d; padding:8px; text-align:left; vertical-align:middle; }
  th { background:#21262d; color:var(--status); }
  .center { text-align:center; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Starlink — Debug Mode (All Satellites)</h1>

      <div class="controls">
        <button id="fetchBtn">Fetch TLEs & Analyze</button>
        <div class="loc" id="locDisplay">Lat: —  Lon: —</div>
      </div>

      <div id="status">Idle.</div>

      <table id="summaryTable" style="display:none;">
        <thead>
          <tr>
            <th class="center">Total Satellites (TLEs)</th>
            <th class="center">Satellites Shown</th>
            <th class="center">Analysis Time</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="totalCount" class="center">0</td>
            <td id="visibleCount" class="center">0</td>
            <td id="analysisTime" class="center">—</td>
          </tr>
        </tbody>
      </table>

      <table id="visibleTable" style="display:none;">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>Max Elev (°)</th>
            <th>Sat Lat/Lon</th>
          </tr>
        </thead>
        <tbody id="visibleBody"></tbody>
      </table>

      <pre id="output">Raw TLE output will appear here after fetch.</pre>
    </div>
  </div>

<script src="https://unpkg.com/satellite.js@4.0.2/dist/satellite.min.js"></script>

<script>
const WORKER_URL = "https://starlink-tle.reinier-olivier.workers.dev/";
const HOURS = 12;
const DEG2RAD = Math.PI / 180;
const RAD2DEG = 180 / Math.PI;

const fetchBtn = document.getElementById('fetchBtn');
const locDisplay = document.getElementById('locDisplay');
const statusEl = document.getElementById('status');
const outputEl = document.getElementById('output');
const summaryTable = document.getElementById('summaryTable');
const totalCountEl = document.getElementById('totalCount');
const visibleCountEl = document.getElementById('visibleCount');
const analysisTimeEl = document.getElementById('analysisTime');
const visibleTable = document.getElementById('visibleTable');
const visibleBody = document.getElementById('visibleBody');

// Get location if possible (optional)
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    locDisplay.textContent = `Lat: ${pos.coords.latitude.toFixed(4)}  Lon: ${pos.coords.longitude.toFixed(4)}`;
  }, () => {}, { timeout: 3000, maximumAge: 60000 });
}

function parseTLEs(raw){
  const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
  const sats = [];
  for (let i = 0; i < lines.length - 2; i++) {
    if (lines[i+1].startsWith("1 ") && lines[i+2].startsWith("2 ")) {
      sats.push({ name: lines[i].replace("STARLINK-",""), line1: lines[i+1], line2: lines[i+2] });
      i += 2;
    }
  }
  return sats;
}

async function analyzeTLEs(rawText){
  const t0 = performance.now();
  const sats = parseTLEs(rawText);
  console.log("Parsed satellites:", sats.length);
  totalCountEl.textContent = sats.length;
  
  if (sats.length === 0) {
    statusEl.textContent = "⚠️ No TLEs found. Check raw output below.";
    return;
  }

  statusEl.textContent = `Analyzing ${sats.length} satellites...`;
  const now = new Date();
  const end = new Date(now.getTime() + HOURS * 3600 * 1000);
  const stepMs = 60 * 1000; // 1-minute steps

  const results = [];

  for (let si = 0; si < sats.length; si++){
    const s = sats[si];
    try {
      const satrec = satellite.twoline2satrec(s.line1, s.line2);
      let maxElev = -Infinity;
      let maxElevTime = null;

      for (let t = now.getTime(); t <= end.getTime(); t += stepMs) {
        const date = new Date(t);
        try {
          const pv = satellite.propagate(satrec, date);
          if (pv.position) {
            // Even without location, record time
            if (maxElevTime === null) maxElevTime = date;
            maxElev = 0; // placeholder
          }
        } catch {}
      }

      if (maxElevTime) {
        // Try to get satellite position
        let satLat = null, satLon = null;
        try {
          const pvMax = satellite.propagate(satrec, maxElevTime);
          if (pvMax.position) {
            const gmstMax = satellite.gstime(maxElevTime);
            const geodetic = satellite.eciToGeodetic(pvMax.position, gmstMax);
            satLat = (geodetic.latitude * RAD2DEG).toFixed(3);
            satLon = (geodetic.longitude * RAD2DEG).toFixed(3);
          }
        } catch {}

        results.push({
          name: s.name,
          maxElevation: maxElev,
          satLat,
          satLon
        });
      }
    } catch {}

    if (si % 50 === 0) await new Promise(r => setTimeout(r, 0));
  }

  visibleBody.innerHTML = "";
  for (const v of results.slice(0, 20)) { // Show first 20 only
    const tr = document.createElement("tr");
    const coordText = (v.satLat && v.satLon) ? `${v.satLat}, ${v.satLon}` : "—";
    tr.innerHTML = `<td>${v.name}</td><td>${v.maxElevation.toFixed(1)}</td><td>${coordText}</td>`;
    visibleBody.appendChild(tr);
  }

  visibleCountEl.textContent = results.length;
  summaryTable.style.display = "table";
  visibleTable.style.display = results.length ? "table" : "none";

  const t1 = performance.now();
  analysisTimeEl.textContent = `${Math.round(t1 - t0)} ms`;
  statusEl.textContent = `Done. Showing ${Math.min(20, results.length)} of ${results.length} satellites.`;
}

async function fetchAndAnalyze(){
  outputEl.textContent = 'Fetching...\n';
  visibleBody.innerHTML = '';
  summaryTable.style.display = 'none';
  visibleTable.style.display = 'none';
  statusEl.textContent = 'Fetching TLEs...';

  try {
    const res = await fetch(WORKER_URL, { cache:"no-store" });
    const text = await res.text();
    outputEl.textContent = text || '[No data]';
    
    if (!text.trim()) {
      statusEl.textContent = "❌ Worker returned empty response.";
      return;
    }

    await analyzeTLEs(text);
  } catch (e) {
    outputEl.textContent = `Fetch error: ${e.message}\n\nMake sure you're online and the worker is up.`;
    statusEl.textContent = "❌ Error fetching TLEs.";
    console.error(e);
  }
}

fetchBtn.addEventListener('click', fetchAndAnalyze);
</script>
</body>
</html>