<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Starlink Visibility – Next 12 Hours</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  button { margin-left: 10px; }
  #status { margin: 10px 0; font-weight: bold; }
  table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
  th { background: #eee; }
</style>
</head>
<body>
<h2>Starlink Visibility – Next 12 Hours</h2>

<div>
  <button id="refresh">Refresh Data</button>
  <span id="location">Locating...</span>
</div>
<div id="status">Idle</div>

<table id="summary">
  <thead><tr><th>Total Satellites</th><th>Visible in Next 12 Hours</th></tr></thead>
  <tbody><tr><td id="total">–</td><td id="visible">–</td></tr></tbody>
</table>

<table id="results">
  <thead><tr><th>Satellite</th><th>First Visible Time</th></tr></thead>
  <tbody></tbody>
</table>

<pre id="raw" style="white-space: pre-wrap;"></pre>

<script>
let lat, lon;

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      const now = new Date();
      document.getElementById("location").textContent =
        `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)} — ${now.toLocaleTimeString()}`;
    }, () => {
      document.getElementById("location").textContent = "Location denied.";
    });
  } else {
    document.getElementById("location").textContent = "Geolocation not supported.";
  }
}

async function fetchData() {
  const status = document.getElementById("status");
  status.textContent = "Requesting data from worker…";
  const start = performance.now();
  const resp = await fetch("https://your-worker-url.workers.dev");
  const text = await resp.text();
  status.textContent = `Data received (${(performance.now() - start).toFixed(1)} ms)`;
  document.getElementById("raw").textContent = text;
  return text;
}

function parseTLE(data) {
  const lines = data.trim().split(/\r?\n/);
  const sats = [];
  for (let i = 0; i < lines.length; i += 3) {
    const name = lines[i].replace("STARLINK-", "").trim();
    const l1 = lines[i + 1], l2 = lines[i + 2];
    if (l1 && l2) sats.push({ name, tle1: l1, tle2: l2 });
  }
  return sats;
}

function findVisible(sats) {
  const observerGd = {
    latitude: lat * Math.PI / 180,
    longitude: lon * Math.PI / 180,
    height: 0
  };
  const now = new Date();
  const end = new Date(now.getTime() + 12 * 60 * 60 * 1000); // 12 hours
  const step = 10; // minutes

  const visible = [];

  sats.forEach(s => {
    const rec = satellite.twoline2satrec(s.tle1, s.tle2);
    for (let t = new Date(now); t <= end; t.setMinutes(t.getMinutes() + step)) {
      const gmst = satellite.gstime(t);
      const posVel = satellite.propagate(rec, t);
      if (!posVel.position) continue;
      const eci = posVel.position;
      const look = satellite.ecfToLookAngles(
        observerGd,
        satellite.eciToEcf(eci, gmst)
      );
      if (look.elevation > 0) {
        visible.push({ name: s.name, time: t.toTimeString().slice(0,5) });
        break; // first visible time only
      }
    }
  });

  return visible;
}

document.getElementById("refresh").addEventListener("click", async () => {
  if (lat === undefined) { getLocation(); alert("Waiting for location…"); return; }
  const data = await fetchData();
  const sats = parseTLE(data);
  const visible = findVisible(sats);

  document.getElementById("total").textContent = sats.length;
  document.getElementById("visible").textContent = visible.length;

  const tbody = document.querySelector("#results tbody");
  tbody.innerHTML = "";
  visible.forEach(v => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${v.name}</td><td>${v.time}</td>`;
    tbody.appendChild(tr);
  });
});

getLocation();
</script>
</body>
</html>