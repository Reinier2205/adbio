<!-- Reinier -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Starlink — Visibility (12h, 10-min steps)</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root { --bg:#0d1117; --panel:#161b22; --muted:#9ca3af; --accent:#22c55e; --text:#c9d1d9; --status:#9cd6ff; }
  html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
  .wrap { max-width:1000px; margin:1.5rem auto; padding:1rem; }
  .panel { background:var(--panel); border:1px solid #30363d; border-radius:10px; padding:1rem; }
  h1 { color:var(--accent); margin:0 0 0.75rem 0; font-size:1.2rem; }
  .controls { display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap; }
  button { background:#16a34a; color:#fff; border:0; padding:0.5rem 0.9rem; border-radius:8px; cursor:pointer; font-weight:600; }
  .small-btn { background:#0b5; padding:0.4rem 0.6rem; font-size:0.9rem; border-radius:6px; }
  .loc { font-family:monospace; color:var(--muted); font-size:0.95rem; }
  #status { margin-top:0.75rem; color:var(--status); font-size:0.95rem; }
  pre { margin-top:1rem; background:#0b0f14; border:1px solid #22272b; padding:1rem; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; color:var(--text); }
  table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.95rem; }
  th, td { border:1px solid #30363d; padding:8px; text-align:left; vertical-align:middle; }
  th { background:#21262d; color:var(--status); }
  .center { text-align:center; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Starlink — Visibility (Next 12h, 10-min steps)</h1>

      <div class="controls">
        <button id="fetchBtn">Fetch TLEs & Analyze</button>
        <div class="loc" id="locDisplay">Lat: —  Lon: —  (time: —)</div>
        <button id="getLocBtn" class="small-btn">Get Location</button>
      </div>

      <div id="status">Idle.</div>

      <table id="summaryTable" style="display:none;">
        <thead>
          <tr>
            <th class="center">Total Satellites</th>
            <th class="center">Visible (next 12h)</th>
            <th class="center">Step</th>
            <th class="center">Analysis Time</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="totalCount" class="center">0</td>
            <td id="visibleCount" class="center">0</td>
            <td id="resolution" class="center">—</td>
            <td id="analysisTime" class="center">—</td>
          </tr>
        </tbody>
      </table>

      <table id="visibleTable" style="display:none;">
        <thead>
          <tr>
            <th>Satellite</th>
            <th>First Visible (local time)</th>
            <th>Max Elevation (°)</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="visibleBody"></tbody>
      </table>

      <pre id="output">Raw TLE output will appear here after fetch.</pre>
    </div>
  </div>

<script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>

<script>
const WORKER_URL = "https://starlink-tle.reinier-olivier.workers.dev/";
const STEP_MINUTES = 10;  // 10-minute intervals
const HOURS = 12;         // Next 12 hours
const DEG2RAD = Math.PI / 180;
const RAD2DEG = 180 / Math.PI;

const fetchBtn = document.getElementById('fetchBtn');
const getLocBtn = document.getElementById('getLocBtn');
const locDisplay = document.getElementById('locDisplay');
const statusEl = document.getElementById('status');
const outputEl = document.getElementById('output');
const summaryTable = document.getElementById('summaryTable');
const totalCountEl = document.getElementById('totalCount');
const visibleCountEl = document.getElementById('visibleCount');
const resolutionEl = document.getElementById('resolution');
const analysisTimeEl = document.getElementById('analysisTime');
const visibleTable = document.getElementById('visibleTable');
const visibleBody = document.getElementById('visibleBody');

let currentLat = null, currentLon = null, locTimestamp = null;

function fmtNum(n,d=6){ return (typeof n === 'number' && isFinite(n)) ? n.toFixed(d) : '—'; }
function fmtTime(ts){ return ts ? new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '—'; }
function updateLocUI(){ locDisplay.textContent = `Lat: ${fmtNum(currentLat,4)}  Lon: ${fmtNum(currentLon,4)}  (time: ${fmtTime(locTimestamp)})`; }

function requestLocation(){
  if (!navigator.geolocation){ locDisplay.textContent = 'Location API not available'; return; }
  locDisplay.textContent = 'Requesting location...';
  navigator.geolocation.getCurrentPosition(pos => {
    currentLat = pos.coords.latitude;
    currentLon = pos.coords.longitude;
    locTimestamp = pos.timestamp || Date.now();
    updateLocUI();
  }, err => {
    locDisplay.textContent = 'Location error: ' + (err.message || 'unknown');
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:30000 });
}

function parseTLEs(raw){
  const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l.length);
  const sats = [];
  for (let i=0; i<lines.length; i++){
    if (i+2<lines.length && lines[i+1].startsWith('1 ') && lines[i+2].startsWith('2 ')){
      sats.push({ name: lines[i].replace(/^STARLINK[- ]?/i,''), line1: lines[i+1], line2: lines[i+2] });
      i+=2;
    }
  }
  return sats;
}

async function analyzeTLEs(rawText){
  const startT = performance.now();
  const sats = parseTLEs(rawText);
  const total = sats.length;
  totalCountEl.textContent = total;
  if (total === 0){ statusEl.textContent = 'No TLEs found.'; return; }

  const now = new Date();
  const end = new Date(now.getTime() + HOURS * 3600 * 1000);
  const stepMs = STEP_MINUTES * 60 * 1000;

  const observer = { latitude: (currentLat || 0)*DEG2RAD, longitude: (currentLon || 0)*DEG2RAD, height:0 };
  const visible = [];

  for (let s of sats){
    let rec;
    try { rec = satellite.twoline2satrec(s.line1, s.line2); } catch { continue; }
    let vis=false, first=null, maxElev=-90;
    for (let t=now.getTime(); t<=end.getTime(); t+=stepMs){
      const d = new Date(t);
      const pv = satellite.propagate(rec,d);
      if (!pv || !pv.position) continue;
      const gmst = satellite.gstime(d);
      const ecf = satellite.eciToEcf(pv.position, gmst);
      const look = satellite.ecfToLookAngles(observer, ecf);
      const elev = look.elevation * RAD2DEG;
      if (elev>maxElev) maxElev = elev;
      if (!vis && elev>0){ vis=true; first=t; }
    }
    if (vis) visible.push({ name:s.name, first:first, elev:maxElev });
    await new Promise(r=>setTimeout(r,0));
  }

  visible.sort((a,b)=>(a.first||0)-(b.first||0));
  visibleBody.innerHTML='';
  for (let v of visible){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${v.name}</td>
      <td>${fmtTime(v.first)}</td>
      <td>${v.elev.toFixed(1)}</td>
      <td>${v.elev>30?'Good pass':v.elev>10?'Low pass':'Horizon'}</td>`;
    visibleBody.appendChild(tr);
  }

  visibleCountEl.textContent=visible.length;
  resolutionEl.textContent=`${STEP_MINUTES} min`;
  analysisTimeEl.textContent=`${Math.round(performance.now()-startT)} ms`;
  summaryTable.style.display='table';
  visibleTable.style.display='table';
  statusEl.textContent=`Analyzed ${total} sats — ${visible.length} visible in next ${HOURS}h.`;
}

async function fetchAndAnalyze(){
  outputEl.textContent='';
  summaryTable.style.display='none'; visibleTable.style.display='none';
  const start=new Date();
  statusEl.textContent=`Fetching at ${start.toLocaleTimeString()}...`;
  try{
    const res=await fetch(WORKER_URL,{cache:"no-store"});
    const text=await res.text();
    outputEl.textContent=text||'[No data returned]';
    await analyzeTLEs(text);
  }catch(e){
    console.error(e);
    statusEl.textContent='Error fetching data';
    outputEl.textContent='Fetch error.';
  }
}

fetchBtn.addEventListener('click',fetchAndAnalyze);
getLocBtn.addEventListener('click',requestLocation);
window.addEventListener('load',requestLocation);
</script>
</body>
</html>