<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EventBingo Admin</title>
  <style>
    :root {
      --primary: #4a90e2;
      --secondary: #7b68ee;
      --accent: #ff6b6b;
      --success: #51cf66;
      --warning: #ffa500;
      --text-dark: #2c3e50;
      --text-light: #ffffff;
      --bg-light: rgba(255, 255, 255, 0.95);
      --bg-dark: rgba(44, 62, 80, 0.9);
      --instagram-pink: #E4405F;
      --instagram-purple: #833AB4;
      --instagram-orange: #F77737;
      --instagram-yellow: #FCAF45;
      --story-gradient: linear-gradient(45deg, var(--instagram-pink), var(--instagram-purple), var(--instagram-orange), var(--instagram-yellow));
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: var(--text-light);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 215, 0, 0.3);
    }

    .header h1 {
      font-size: 3rem;
      margin: 0 0 10px 0;
      background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
      margin: 0;
    }

    /* Section Styles */
    .section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .section.hidden {
      display: none;
    }

    /* Sticky Workflow Steps */
    .workflow-steps-sticky {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      margin: -30px -30px 30px -30px;
      border-radius: 20px 20px 0 0;
      border-bottom: 2px solid rgba(255, 215, 0, 0.3);
    }

    /* Workflow Step Sections */
    .workflow-step-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .workflow-step-section.active {
      border-color: rgba(255, 215, 0, 0.5);
      background: rgba(255, 255, 255, 0.1);
    }

    .workflow-step-section.completed {
      border-color: rgba(81, 207, 102, 0.5);
      background: rgba(81, 207, 102, 0.05);
    }

    .workflow-step-section.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .step-section-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .step-section-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border: 2px solid rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
    }

    .workflow-step-section.active .step-section-number {
      background: var(--story-gradient);
      border-color: #ffd700;
    }

    .workflow-step-section.completed .step-section-number {
      background: #51cf66;
      border-color: #51cf66;
    }

    .step-section-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: #ffd700;
    }

    .step-section-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .workflow-step-section.active .step-section-content {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 20px;
      color: #ffd700;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .section-subtitle {
      text-align: center;
      color: #e0e0e0;
      margin-bottom: 25px;
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Button Styles */
    .btn {
      background: var(--story-gradient);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--story-gradient);
    }

    .btn-success {
      background: linear-gradient(135deg, #51cf66, #69db7c);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-small {
      padding: 10px 20px;
      font-size: 0.9rem;
    }

    .btn-large {
      padding: 20px 40px;
      font-size: 1.3rem;
      width: 100%;
      margin: 20px 0;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #e0e0e0;
      font-size: 1rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Segoe UI', sans-serif;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
      background: rgba(255, 255, 255, 0.15);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 120px;
      line-height: 1.5;
    }

    .form-help {
      font-size: 0.9rem;
      color: #999;
      margin-top: 5px;
      font-style: italic;
    }

    /* Events List Styles */
    .events-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .event-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .event-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      border-color: rgba(255, 215, 0, 0.5);
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .event-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 5px;
    }

    .event-code {
      background: rgba(255, 215, 0, 0.2);
      color: #ffd700;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .event-description {
      color: #e0e0e0;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .event-meta {
      display: flex;
      gap: 20px;
      font-size: 0.9rem;
      color: #999;
      margin-bottom: 15px;
    }

    .event-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Workflow Steps */
    .workflow-steps {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      gap: 20px;
    }

    .workflow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0.5;
      transition: all 0.3s ease;
    }

    .workflow-step.active {
      opacity: 1;
    }

    .workflow-step.completed {
      opacity: 1;
      color: #51cf66;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .workflow-step.active .step-number {
      background: var(--story-gradient);
      border-color: #ffd700;
    }

    .workflow-step.completed .step-number {
      background: #51cf66;
      border-color: #51cf66;
    }

    .step-label {
      font-size: 0.9rem;
      text-align: center;
      max-width: 100px;
    }

    /* AI Prompt Styles */
    .ai-prompt-result {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .ai-instructions {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .ai-instructions h4 {
      color: #ffd700;
      margin: 0 0 15px 0;
      font-size: 1.1rem;
    }

    .ai-instructions ol {
      color: #e0e0e0;
      font-size: 0.95rem;
      margin: 0;
      padding-left: 20px;
    }

    .ai-instructions li {
      margin-bottom: 8px;
      line-height: 1.4;
    }

    /* Preview Grid */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      max-width: 700px;
      margin: 0 auto;
    }

    .preview-square {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      font-size: 0.85rem;
      line-height: 1.3;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: #e0e0e0;
    }

    .preview-square.center {
      background: var(--story-gradient);
      color: white;
      font-weight: bold;
      border-color: rgba(255, 215, 0, 0.5);
    }

    .preview-square.empty {
      background: rgba(255, 107, 107, 0.2);
      border-color: rgba(255, 107, 107, 0.5);
      color: #ff6b6b;
    }

    .preview-square.duplicate {
      background: rgba(255, 165, 0, 0.2);
      border-color: rgba(255, 165, 0, 0.5);
      color: #ffa500;
    }

    /* Messages */
    .message {
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .message.success {
      background: rgba(81, 207, 102, 0.2);
      color: #51cf66;
      border: 1px solid rgba(81, 207, 102, 0.3);
    }

    .message.error {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .message.warning {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
      border: 1px solid rgba(255, 165, 0, 0.3);
    }

    /* Loading States */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: currentColor;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .btn-loading {
      opacity: 0.7;
      cursor: not-allowed !important;
      pointer-events: none;
    }

    /* Lock Status */
    .lock-status {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .lock-status.locked {
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }

    .lock-status.unlocked {
      background: rgba(81, 207, 102, 0.2);
      border: 1px solid rgba(81, 207, 102, 0.3);
      color: #51cf66;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .workflow-steps {
        flex-direction: column;
        gap: 10px;
      }
      
      .workflow-step {
        flex-direction: row;
        gap: 15px;
      }
      
      .step-label {
        max-width: none;
        text-align: left;
      }
      
      .preview-grid {
        gap: 6px;
      }
      
      .preview-square {
        font-size: 0.75rem;
        min-height: 60px;
        padding: 8px;
      }
      
      .event-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .event-actions {
        justify-content: center;
      }
    }

    /* Validation Styles */
    .validation-messages {
      margin-bottom: 20px;
    }

    .validation-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }

    .validation-message.error {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .validation-message.warning {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
      border: 1px solid rgba(255, 165, 0, 0.3);
    }

    .validation-message.success {
      background: rgba(81, 207, 102, 0.2);
      color: #51cf66;
      border: 1px solid rgba(81, 207, 102, 0.3);
    }

    /* Success Notification */
    .success-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(81, 207, 102, 0.95);
      color: white;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: 350px;
      backdrop-filter: blur(10px);
    }

    .success-notification.show {
      transform: translateX(0);
    }

    .notification-title {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 1.1rem;
    }

    .notification-message {
      font-size: 0.95rem;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üéØ EventBingo Admin</h1>
      <p>Create and manage your photo challenge events</p>
    </div>

    <!-- All Events Section (Default View) -->
    <div id="allEventsSection" class="section">
      <div class="events-header">
        <div class="section-title">
          <span>üìã</span>
          All Events
        </div>
        <button class="btn btn-primary" onclick="startCreateEventWorkflow()">
          <span>‚ûï</span>
          Create New Event
        </button>
      </div>
      
      <div id="eventsList">
        <div class="loading">
          <span class="loading-spinner"></span>
          Loading events...
        </div>
      </div>
    </div>

    <!-- Create Event Workflow -->
    <div id="createEventWorkflow" class="section hidden">
      <!-- Sticky Workflow Steps Indicator -->
      <div class="workflow-steps-sticky">
        <div class="workflow-steps">
          <div class="workflow-step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">Event Details</div>
          </div>
          <div class="workflow-step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">AI Prompt</div>
          </div>
          <div class="workflow-step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Photo Squares</div>
          </div>
          <div class="workflow-step" id="step4">
            <div class="step-number">4</div>
            <div class="step-label">Preview & Save</div>
          </div>
        </div>
      </div>

      <!-- Step 1: Event Details -->
      <div id="eventDetailsSection" class="workflow-step-section active">
        <div class="step-section-header">
          <div class="step-section-number">1</div>
          <div class="step-section-title">Event Details</div>
        </div>
        <div class="step-section-content">
          <div class="section-subtitle">
            Let's start by setting up the basic information for your event
          </div>

          <form id="eventDetailsForm">
            <div class="form-group">
              <label for="eventTitle">Event Title *</label>
              <input type="text" id="eventTitle" placeholder="e.g., Sarah's 30th Birthday Party" required>
              <div class="form-help">Give your event a memorable name</div>
            </div>
            
            <div class="form-group">
              <label for="eventDescription">Event Description *</label>
              <textarea id="eventDescription" placeholder="Describe your event - what's the occasion, who's attending, what makes it special..." required></textarea>
              <div class="form-help">This helps create better photo challenges</div>
            </div>
            
            <div class="form-group">
              <label for="eventCode">Event Code (optional)</label>
              <input type="text" id="eventCode" placeholder="Leave empty for auto-generation" maxlength="20">
              <div class="form-help">Players will use this code to join. Use letters, numbers, and hyphens only</div>
            </div>
            
            <div class="form-group">
              <label for="adminUser">Admin Username *</label>
              <input type="text" id="adminUser" placeholder="Your name or username" required>
              <div class="form-help">This identifies you as the event organizer</div>
            </div>

            <div class="step-actions">
              <button type="button" class="btn btn-secondary" onclick="cancelCreateEvent()">
                <span>‚ùå</span>
                Cancel
              </button>
              <button type="submit" class="btn btn-primary" style="flex: 1;" id="eventDetailsBtn">
                <span>‚û°Ô∏è</span>
                Continue to AI Prompt
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Step 2: AI Prompt Generator -->
      <div id="aiPromptSection" class="workflow-step-section disabled">
        <div class="step-section-header">
          <div class="step-section-number">2</div>
          <div class="step-section-title">AI Prompt Generator</div>
        </div>
        <div class="step-section-content">
          <div class="section-subtitle">
            Generate a custom prompt to create personalized photo challenges with AI
          </div>

          <form id="aiPromptForm">
            <div class="form-group">
              <label for="aiEventNames">People Who Will Be Photographed</label>
              <input type="text" id="aiEventNames" placeholder="e.g., Sarah, Mike, Emma, David, Lisa">
              <div class="form-help">Names of key people at the event (comma-separated). This personalizes the challenges</div>
            </div>
            
            <div class="form-group">
              <label for="aiEventTheme">Event Theme/Type</label>
              <input type="text" id="aiEventTheme" placeholder="e.g., Birthday party, Wedding reception, Corporate retreat">
              <div class="form-help">What type of event is this?</div>
            </div>
            
            <div class="form-group">
              <label for="aiEventLocation">Location (optional)</label>
              <textarea id="aiEventLocation" placeholder="e.g., Beachside resort, Backyard garden, Downtown hotel ballroom" rows="2"></textarea>
              <div class="form-help">Where is the event taking place? This helps create location-specific challenges</div>
            </div>
            
            <div class="form-group">
              <label for="aiEventActivities">Expected Activities to Photograph</label>
              <textarea id="aiEventActivities" placeholder="e.g., Dancing, cake cutting, speeches, games, live music, cocktail hour" rows="3"></textarea>
              <div class="form-help">What activities or moments do you want to capture?</div>
            </div>
            
            <div class="form-group">
              <label for="aiOtherInstructions">Other Instructions (optional)</label>
              <textarea id="aiOtherInstructions" placeholder="Any special requirements, themes, or specific types of photos you want..." rows="2"></textarea>
              <div class="form-help">Additional guidance for the AI to create better challenges</div>
            </div>

            <button type="button" class="btn btn-primary btn-large" onclick="generateAIPrompt()">
              <span>üéØ</span>
              Generate AI Prompt
            </button>
          </form>

          <div id="aiPromptResult" class="ai-prompt-result hidden">
            <div class="form-group">
              <label for="generatedPrompt">Generated AI Prompt</label>
              <textarea id="generatedPrompt" readonly rows="15" style="background: rgba(255,255,255,0.05); font-family: 'Courier New', monospace; font-size: 0.9rem;"></textarea>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
              <button type="button" class="btn btn-success" onclick="copyPromptToClipboard()">
                <span>üìã</span>
                Copy to Clipboard
              </button>
              <button type="button" class="btn btn-secondary" onclick="regeneratePrompt()">
                <span>üîÑ</span>
                Regenerate
              </button>
            </div>
            
            <div class="ai-instructions">
              <h4>üìù How to Use This Prompt:</h4>
              <ol>
                <li><strong>Copy the prompt above</strong> using the "Copy to Clipboard" button</li>
                <li><strong>Open your favorite AI tool</strong> (ChatGPT, Claude, Gemini, etc.)</li>
                <li><strong>Paste and send the prompt</strong> to the AI</li>
                <li><strong>Copy the AI's response</strong> (it should be 25 photo challenges)</li>
                <li><strong>Return here and paste the response</strong> in the next step</li>
              </ol>
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" onclick="goToPreviousStep(2)">
              <span>‚¨ÖÔ∏è</span>
              Back to Details
            </button>
            <button type="button" class="btn btn-primary" onclick="goToNextStep(2)" style="flex: 1;" id="aiPromptBtn">
              <span>‚û°Ô∏è</span>
              Continue to Photo Squares
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Photo Squares Configuration -->
      <div id="photoSquaresSection" class="workflow-step-section disabled">
        <div class="step-section-header">
          <div class="step-section-number">3</div>
          <div class="step-section-title">Photo Squares Configuration</div>
        </div>
        <div class="step-section-content">
          <div class="section-subtitle">
            Paste the AI response here and edit the 25 photo challenges as needed
          </div>

          <div class="form-group">
            <label for="squaresInput">25 Photo Challenges (one per line)</label>
            <textarea 
              id="squaresInput" 
              placeholder="Paste the AI response here, or enter your own 25 photo challenges (one per line):&#10;&#10;A photo with someone laughing&#10;Someone trying the food&#10;A group photo by the entrance&#10;Someone dancing&#10;A candid moment during speeches&#10;..." 
              rows="20" 
              style="font-family: 'Segoe UI', sans-serif; line-height: 1.4;"
            ></textarea>
            <div id="squareCount" style="font-size: 0.9rem; color: #999; margin-top: 8px;">
              0 / 25 squares
            </div>
          </div>
          
          <div id="validationMessages" class="validation-messages"></div>
          
          <div style="display: flex; gap: 15px; margin-bottom: 20px;">
            <button type="button" class="btn btn-secondary btn-small" onclick="loadDefaultSquares()">
              <span>üîÑ</span>
              Load Default Squares
            </button>
            <button type="button" class="btn btn-secondary btn-small" onclick="clearSquares()">
              <span>üóëÔ∏è</span>
              Clear All
            </button>
          </div>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" onclick="goToPreviousStep(3)">
              <span>‚¨ÖÔ∏è</span>
              Back to AI Prompt
            </button>
            <button type="button" class="btn btn-primary" onclick="goToNextStep(3)" style="flex: 1;" id="photoSquaresBtn">
              <span>‚û°Ô∏è</span>
              Continue to Preview
            </button>
          </div>
        </div>
      </div>

      <!-- Step 4: Preview & Save -->
      <div id="previewSaveSection" class="workflow-step-section disabled">
        <div class="step-section-header">
          <div class="step-section-number">4</div>
          <div class="step-section-title">Preview & Save Event</div>
        </div>
        <div class="step-section-content">
          <div class="section-subtitle">
            Review your event and photo challenges before saving
          </div>

          <!-- Event Summary -->
          <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
            <h3 style="color: #ffd700; margin: 0 0 15px 0;">Event Summary</h3>
            <div id="eventSummary"></div>
          </div>

          <!-- Live Preview Grid -->
          <div style="margin-bottom: 30px;">
            <h3 style="color: #ffd700; text-align: center; margin-bottom: 20px;">5√ó5 Bingo Grid Preview</h3>
            <div id="previewGrid" class="preview-grid"></div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" onclick="goToPreviousStep(4)">
              <span>‚¨ÖÔ∏è</span>
              Back to Edit Squares
            </button>
            <button type="button" class="btn btn-secondary btn-small" onclick="testSquaresSaving()">
              <span>üß™</span>
              Test Squares
            </button>
            <button type="button" class="btn btn-success" onclick="saveEvent()" style="flex: 1;" id="saveEventBtn">
              <span>üíæ</span>
              Save Event & Lock
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Management Section -->
    <div id="eventManagementSection" class="section hidden">
      <div class="section-title">
        <span>‚öôÔ∏è</span>
        Manage Event
      </div>
      
      <div id="selectedEventDetails"></div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button type="button" class="btn btn-secondary" onclick="backToAllEvents()">
          <span>‚¨ÖÔ∏è</span>
          Back to All Events
        </button>
        <button type="button" class="btn btn-danger" onclick="deleteSelectedEvent()">
          <span>üóëÔ∏è</span>
          Delete Event
        </button>
        <button type="button" class="btn btn-primary" onclick="viewSelectedEvent()">
          <span>üëÅÔ∏è</span>
          View Event
        </button>
      </div>
    </div>
  </div>

  <!-- Success Notification -->
  <div id="successNotification" class="success-notification">
    <div class="notification-title" id="notificationTitle"></div>
    <div class="notification-message" id="notificationMessage"></div>
  </div>

  <script>
    const workerURL = "https://shy-recipe-5fb1.reinier-olivier.workers.dev/";
    let currentWorkflowData = {};
    let currentSelectedEvent = null;

    // Default squares for fallback
    const defaultSquaresList = [
      "'n Ou foto saam met Anneke",
      "'n Foto van 'n vorige verjaarsdag of braai",
      "Die oudste selfie wat julle saam het",
      "Anneke wat kaalvoet loop (bonus: vuil voete)",
      "Anneke wat 'n bier drink (bonus: cheers oomblik)",
      "Iemand wat iets by Anneke leen",
      "Oliver wat saam met iemand bal speel",
      "Kesia saam met 'n 'tannie' of 'oom'",
      "Almal bymekaar om die kampvuur",
      "Anneke wat in vrede sit en lees",
      "Oggendkoffie in 'n beker wat nie aan jou behoort nie",
      "Oliver wat 'help' met iets",
      "'n Foto van die sonsondergang",
      "Iemand wat sukkel met kamp opslaan",
      "Anneke se lag vasgevang in 'n spontane foto",
      "'n Kamp speletjie of aktiwiteit",
      "'n Kreatiewe foto van bier of koffie (bonus: albei)",
      "Oliver op sy fiets",
      "'n Groepsfoto van almal",
      "Iemand wat iets soek wat verlore is (bv. foon, skoen, drankie)",
      "'n Foto wat gewys iets is geleen vir kamp",
      "Oliver wat iets in tee doop",
      "Anneke wat ontspan met 'n boek",
      "Kesia wat glimlag",
      "Almal wat totsiens waai by die vuir"
    ];

    // AI Prompt Generator Class
    class AIPromptGenerator {
      constructor(eventContext) {
        this.context = eventContext;
      }
      
      generatePrompt() {
        const { title, names, theme, location, activities, otherInstructions } = this.context;
        
        const namesList = names ? names.split(',').map(n => n.trim()).filter(n => n.length > 0) : [];
        const namesText = namesList.length > 0 ? namesList.join(', ') : 'event attendees';
        
        return `Create 25 photo challenge squares for a bingo-style game for the following event:

Event: ${title}
Theme/Type: ${theme || 'General event'}
Location: ${location || 'Various locations'}
People attending: ${namesText}
Expected activities: ${activities || 'Various activities'}
${otherInstructions ? `Additional instructions: ${otherInstructions}` : ''}

Please create exactly 25 photo challenges that are:
1. Fun and engaging for the attendees
2. Achievable during the event
3. Specific to the people, location, and activities mentioned above
4. Varied in difficulty (some easy, some challenging)
5. Appropriate for all ages
6. Encourage interaction and creativity

Guidelines for photo challenges:
- Include specific names when possible (e.g., "Photo of ${namesList.length > 0 ? namesList[0] : '[name]'} laughing")
- Reference the location and setting
- Include both individual and group challenges
- Mix action shots with posed photos
- Include challenges about emotions/expressions
- Include challenges about food, decorations, or event details
- Make some challenges about interactions between people

Format Requirements:
- Return exactly 25 lines
- One challenge per line
- No numbering, bullets, or extra formatting
- Each challenge should be 3-15 words
- Start each line with a capital letter
- Use clear, simple language

Example format:
A photo with ${namesList.length > 0 ? namesList[0] : 'someone'} laughing
Someone trying the food
A group photo by the entrance
${namesList.length > 1 ? namesList[1] : 'Someone'} dancing
A candid moment during speeches
...

Please generate 25 unique photo challenges following these guidelines.`;
      }
    }

    // Initialize the admin page
    document.addEventListener('DOMContentLoaded', function() {
      loadAllEvents();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Event details form
      document.getElementById('eventDetailsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleEventDetailsSubmit();
      });

      // Squares input real-time validation
      document.getElementById('squaresInput').addEventListener('input', function() {
        updateSquareCount();
        validateSquares();
        updatePreview();
      });
    }

    // Navigation Functions
    function startCreateEventWorkflow() {
      document.getElementById('allEventsSection').classList.add('hidden');
      document.getElementById('createEventWorkflow').classList.remove('hidden');
      document.getElementById('eventManagementSection').classList.add('hidden');
      
      // Reset workflow
      currentWorkflowData = {};
      resetWorkflowSteps();
      activateStep(1);
    }

    function cancelCreateEvent() {
      if (confirm('Are you sure you want to cancel? All entered data will be lost.')) {
        backToAllEvents();
      }
    }

    function backToAllEvents() {
      document.getElementById('allEventsSection').classList.remove('hidden');
      document.getElementById('createEventWorkflow').classList.add('hidden');
      document.getElementById('eventManagementSection').classList.add('hidden');
      
      // Reload events to show any new ones
      loadAllEvents();
    }

    function resetWorkflowSteps() {
      // Reset all step sections
      document.querySelectorAll('.workflow-step-section').forEach((section, index) => {
        section.classList.remove('active', 'completed');
        if (index === 0) {
          section.classList.add('active');
        } else {
          section.classList.add('disabled');
        }
      });
      
      // Reset step indicators
      document.querySelectorAll('.workflow-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index === 0) {
          step.classList.add('active');
        }
      });
    }

    function activateStep(stepNumber) {
      // Update step indicators in sticky header
      document.querySelectorAll('.workflow-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNumber) {
          step.classList.add('completed');
        } else if (index + 1 === stepNumber) {
          step.classList.add('active');
        }
      });
      
      // Update step sections
      document.querySelectorAll('.workflow-step-section').forEach((section, index) => {
        section.classList.remove('active');
        if (index + 1 < stepNumber) {
          section.classList.add('completed');
          section.classList.remove('disabled');
        } else if (index + 1 === stepNumber) {
          section.classList.add('active');
          section.classList.remove('disabled');
        } else {
          section.classList.add('disabled');
        }
      });
      
      // Pre-populate fields if returning to a step
      if (stepNumber === 2 && currentWorkflowData.eventDetails) {
        populateAIPromptFields();
      } else if (stepNumber === 4) {
        updateEventSummary();
        updatePreview();
      }
    }

    function goToNextStep(currentStep) {
      // Validate and store data for current step before proceeding
      if (currentStep === 2) {
        // Store AI context even if prompt wasn't generated
        const names = document.getElementById('aiEventNames').value.trim();
        const theme = document.getElementById('aiEventTheme').value.trim();
        const location = document.getElementById('aiEventLocation').value.trim();
        const activities = document.getElementById('aiEventActivities').value.trim();
        const otherInstructions = document.getElementById('aiOtherInstructions').value.trim();
        
        currentWorkflowData.aiContext = {
          title: currentWorkflowData.eventDetails.title,
          names,
          theme,
          location,
          activities,
          otherInstructions
        };
      } else if (currentStep === 3) {
        // Validate squares before going to preview
        if (!validateSquares()) {
          showMessage('Please fix the validation errors before continuing', 'error');
          return;
        }
        
        const squares = document.getElementById('squaresInput').value
          .split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0);
        
        if (squares.length !== 25) {
          showMessage('You must have exactly 25 squares to continue', 'error');
          return;
        }
        
        // Store squares in workflow data
        currentWorkflowData.squares = squares;
      }
      
      const nextStep = currentStep + 1;
      if (nextStep <= 4) {
        const btn = document.querySelector(`#${getCurrentStepButtonId(currentStep)}`);
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span class="loading-spinner"></span>Loading...';
          btn.disabled = true;
          
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            activateStep(nextStep);
          }, 500);
        } else {
          activateStep(nextStep);
        }
      }
    }

    function getCurrentStepButtonId(step) {
      const buttonIds = {
        1: 'eventDetailsBtn',
        2: 'aiPromptBtn', 
        3: 'photoSquaresBtn',
        4: 'saveEventBtn'
      };
      return buttonIds[step];
    }

    function goToPreviousStep(currentStep) {
      const prevStep = currentStep - 1;
      if (prevStep >= 1) {
        activateStep(prevStep);
      }
    }

    // Step 1: Event Details
    function handleEventDetailsSubmit() {
      const title = document.getElementById('eventTitle').value.trim();
      const description = document.getElementById('eventDescription').value.trim();
      const code = document.getElementById('eventCode').value.trim();
      const adminUser = document.getElementById('adminUser').value.trim();
      
      if (!title || !description || !adminUser) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('eventDetailsBtn');
      const originalText = submitBtn.innerHTML;
      
      // Show loading state
      submitBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';
      submitBtn.disabled = true;
      
      // Simulate processing time for better UX
      setTimeout(() => {
        // Store event details
        currentWorkflowData.eventDetails = {
          title,
          description,
          code: code || generateEventCode(),
          adminUser
        };
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Move to next step
        activateStep(2);
      }, 800);
    }

    function populateAIPromptFields() {
      if (currentWorkflowData.eventDetails) {
        // Pre-populate theme field with event title context
        const themeField = document.getElementById('aiEventTheme');
        if (!themeField.value) {
          const title = currentWorkflowData.eventDetails.title.toLowerCase();
          if (title.includes('birthday')) {
            themeField.value = 'Birthday party';
          } else if (title.includes('wedding')) {
            themeField.value = 'Wedding celebration';
          } else if (title.includes('corporate') || title.includes('work')) {
            themeField.value = 'Corporate event';
          }
        }
      }
    }

    // Step 2: AI Prompt Generation
    function generateAIPrompt() {
      const names = document.getElementById('aiEventNames').value.trim();
      const theme = document.getElementById('aiEventTheme').value.trim();
      const location = document.getElementById('aiEventLocation').value.trim();
      const activities = document.getElementById('aiEventActivities').value.trim();
      const otherInstructions = document.getElementById('aiOtherInstructions').value.trim();
      
      const eventContext = {
        title: currentWorkflowData.eventDetails.title,
        names,
        theme,
        location,
        activities,
        otherInstructions
      };
      
      const generator = new AIPromptGenerator(eventContext);
      const prompt = generator.generatePrompt();
      
      document.getElementById('generatedPrompt').value = prompt;
      document.getElementById('aiPromptResult').classList.remove('hidden');
      
      // Store AI context
      currentWorkflowData.aiContext = eventContext;
      currentWorkflowData.generatedPrompt = prompt;
      
      // Scroll to result
      document.getElementById('aiPromptResult').scrollIntoView({ behavior: 'smooth' });
    }

    function regeneratePrompt() {
      generateAIPrompt();
    }

    async function copyPromptToClipboard() {
      const prompt = document.getElementById('generatedPrompt').value;
      
      try {
        await navigator.clipboard.writeText(prompt);
        showSuccessNotification('Prompt Copied!', 'Paste it into your favorite AI tool');
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = prompt;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showSuccessNotification('Prompt Copied!', 'Paste it into your favorite AI tool');
      }
    }

    // Step 3: Squares Configuration
    function updateSquareCount() {
      const input = document.getElementById('squaresInput');
      const squares = input.value.split('\n').filter(line => line.trim().length > 0);
      document.getElementById('squareCount').textContent = `${squares.length} / 25 squares`;
    }

    function validateSquares() {
      const input = document.getElementById('squaresInput');
      const squares = input.value.split('\n').filter(line => line.trim().length > 0);
      const messagesContainer = document.getElementById('validationMessages');
      
      messagesContainer.innerHTML = '';
      
      const messages = [];
      
      // Check count
      if (squares.length < 25) {
        messages.push({
          type: 'error',
          text: `Need ${25 - squares.length} more squares (currently ${squares.length}/25)`
        });
      } else if (squares.length > 25) {
        messages.push({
          type: 'error',
          text: `Too many squares! Remove ${squares.length - 25} squares (currently ${squares.length}/25)`
        });
      } else {
        messages.push({
          type: 'success',
          text: 'Perfect! You have exactly 25 squares'
        });
      }
      
      // Check for empty squares
      const emptySquares = [];
      squares.forEach((square, index) => {
        if (square.trim().length === 0) {
          emptySquares.push(index + 1);
        }
      });
      
      if (emptySquares.length > 0) {
        messages.push({
          type: 'warning',
          text: `Empty squares at lines: ${emptySquares.join(', ')}`
        });
      }
      
      // Check for duplicates
      const duplicates = findDuplicates(squares);
      if (duplicates.length > 0) {
        messages.push({
          type: 'warning',
          text: `${duplicates.length} duplicate square(s) found`
        });
      }
      
      // Display messages
      messages.forEach(message => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `validation-message ${message.type}`;
        messageDiv.textContent = message.text;
        messagesContainer.appendChild(messageDiv);
      });
      
      return messages.filter(m => m.type === 'error').length === 0;
    }

    function findDuplicates(squares) {
      const seen = new Map();
      const duplicates = [];
      
      squares.forEach((square, index) => {
        const normalized = square.trim().toLowerCase();
        if (normalized.length === 0) return;
        
        if (seen.has(normalized)) {
          duplicates.push({ text: square.trim(), positions: [seen.get(normalized), index + 1] });
        } else {
          seen.set(normalized, index + 1);
        }
      });
      
      return duplicates;
    }

    function loadDefaultSquares() {
      if (confirm('This will replace all current squares with default ones. Continue?')) {
        document.getElementById('squaresInput').value = defaultSquaresList.join('\n');
        updateSquareCount();
        validateSquares();
        updatePreview();
      }
    }

    function clearSquares() {
      if (confirm('This will clear all squares. Continue?')) {
        document.getElementById('squaresInput').value = '';
        updateSquareCount();
        validateSquares();
        updatePreview();
      }
    }

    // Step 4: Preview & Save
    function updateEventSummary() {
      const summaryContainer = document.getElementById('eventSummary');
      const details = currentWorkflowData.eventDetails;
      
      summaryContainer.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div><strong>Title:</strong> ${details.title}</div>
          <div><strong>Code:</strong> ${details.code}</div>
          <div><strong>Admin:</strong> ${details.adminUser}</div>
        </div>
        <div style="margin-top: 15px;"><strong>Description:</strong> ${details.description}</div>
      `;
    }

    function updatePreview() {
      const input = document.getElementById('squaresInput');
      const squares = input.value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      const previewGrid = document.getElementById('previewGrid');
      
      previewGrid.innerHTML = '';
      
      // Create 25 squares (5x5 grid)
      for (let i = 0; i < 25; i++) {
        const square = document.createElement('div');
        square.className = 'preview-square';
        
        if (i === 12) { // Center square (FREE SPACE)
          square.textContent = 'FREE SPACE';
          square.classList.add('center');
        } else {
          const squareIndex = i < 12 ? i : i - 1; // Adjust for FREE SPACE
          if (squares[squareIndex]) {
            square.textContent = squares[squareIndex];
            
            // Check for duplicates
            const duplicates = findDuplicates(squares);
            const isDuplicate = duplicates.some(dup => 
              dup.text.toLowerCase() === squares[squareIndex].toLowerCase()
            );
            
            if (isDuplicate) {
              square.classList.add('duplicate');
            }
          } else {
            square.textContent = 'Empty';
            square.classList.add('empty');
          }
        }
        
        previewGrid.appendChild(square);
      }
    }

    async function saveEvent() {
      const saveBtn = document.getElementById('saveEventBtn');
      const originalText = saveBtn.innerHTML;
      
      // Validate squares one more time
      if (!validateSquares()) {
        showMessage('Please fix the validation errors before saving', 'error');
        return;
      }
      
      const squares = document.getElementById('squaresInput').value
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
      
      if (squares.length !== 25) {
        showMessage('You must have exactly 25 squares to save the event', 'error');
        return;
      }
      
      try {
        saveBtn.innerHTML = '<span class="loading-spinner"></span>Saving Event...';
        saveBtn.disabled = true;
        
        // Ensure we have a valid aiContext
        const aiContext = currentWorkflowData.aiContext || {
          title: currentWorkflowData.eventDetails.title,
          names: '',
          theme: '',
          location: '',
          activities: '',
          otherInstructions: ''
        };

        const eventData = {
          ...currentWorkflowData.eventDetails,
          squares: squares,
          aiContext: aiContext,
          isLocked: true, // Lock the event after creation
          lockedAt: new Date().toISOString(),
          lockReason: 'created'
        };
        
        console.log('Event details:', currentWorkflowData.eventDetails); // Debug log
        console.log('Squares being sent:', squares); // Debug log
        console.log('AI Context:', currentWorkflowData.aiContext); // Debug log
        console.log('Full event data being sent:', eventData); // Debug log
        
        const response = await fetch(`${workerURL}admin/create-event`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(eventData)
        });
        
        if (response.ok) {
          const newEvent = await response.json();
          
          console.log('Event saved successfully:', newEvent); // Debug log
          
          showSuccessNotification(
            'Event Created Successfully!',
            `"${eventData.title}" is ready for players. Event code: ${eventData.code}`
          );
          
          // Reset workflow and go back to events list
          setTimeout(() => {
            backToAllEvents();
          }, 3000);
          
        } else {
          const error = await response.text();
          console.error('Server error:', error); // Debug log
          showMessage(`Error creating event: ${error}`, 'error');
        }
        
      } catch (err) {
        console.error('Error saving event:', err);
        showMessage('Failed to save event. Please check your connection and try again.', 'error');
      } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }

    // Events Management
    async function loadAllEvents() {
      const eventsList = document.getElementById('eventsList');
      
      eventsList.innerHTML = '<div class="loading"><span class="loading-spinner"></span>Loading events...</div>';
      
      try {
        const response = await fetch(`${workerURL}admin/events`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const events = await response.json();
        
        if (events.length === 0) {
          eventsList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #999;">
              <div style="font-size: 3rem; margin-bottom: 20px;">üìã</div>
              <h3>No Events Yet</h3>
              <p>Create your first EventBingo event to get started!</p>
            </div>
          `;
          return;
        }
        
        eventsList.innerHTML = events.map(event => `
          <div class="event-item" onclick="selectEventForManagement('${event.code}')">
            <div class="event-header">
              <div>
                <div class="event-title">${event.title}</div>
                <div class="event-meta">
                  <span>üë§ ${event.adminUser || 'Unknown'}</span>
                  <span>üìÖ ${event.createdAt ? new Date(event.createdAt).toLocaleDateString() : 'Unknown'}</span>
                  <span>${event.isLocked ? 'üîí Locked' : 'üîì Unlocked'}</span>
                </div>
              </div>
              <div class="event-code">${event.code}</div>
            </div>
            <div class="event-description">${event.description}</div>
            <div class="event-actions" onclick="event.stopPropagation()">
              <button class="btn btn-small btn-secondary" onclick="viewEvent('${event.code}')">
                <span>üëÅÔ∏è</span> View
              </button>
              <button class="btn btn-small btn-danger" onclick="deleteEvent('${event.code}')">
                <span>üóëÔ∏è</span> Delete
              </button>
            </div>
          </div>
        `).join('');
        
      } catch (err) {
        console.error('Error loading events:', err);
        eventsList.innerHTML = `
          <div class="message error">
            Failed to load events. Please check your connection and try again.
          </div>
        `;
      }
    }

    function selectEventForManagement(eventCode) {
      // This could be expanded to show detailed event management
      // For now, we'll just show a basic management interface
      currentSelectedEvent = eventCode;
      
      document.getElementById('allEventsSection').classList.add('hidden');
      document.getElementById('eventManagementSection').classList.remove('hidden');
      
      loadEventDetails(eventCode);
    }

    async function loadEventDetails(eventCode) {
      const detailsContainer = document.getElementById('selectedEventDetails');
      
      try {
        const response = await fetch(`${workerURL}event-info?event=${eventCode}`);
        
        if (response.ok) {
          const event = await response.json();
          
          detailsContainer.innerHTML = `
            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 25px; margin-bottom: 25px;">
              <h3 style="color: #ffd700; margin: 0 0 20px 0;">${event.title}</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div><strong>Event Code:</strong> ${event.code}</div>
                <div><strong>Admin:</strong> ${event.adminUser || 'Unknown'}</div>
                <div><strong>Status:</strong> ${event.isLocked ? 'üîí Locked' : 'üîì Unlocked'}</div>
                <div><strong>Squares:</strong> ${event.squares ? event.squares.length : 'Default'}</div>
              </div>
              <div><strong>Description:</strong> ${event.description}</div>
              ${event.isLocked ? `
                <div class="lock-status locked" style="margin-top: 20px;">
                  <span>üîí</span>
                  <div>
                    <div><strong>Event is Locked</strong></div>
                    <div>Locked ${event.lockReason === 'first_photo' ? 'after first photo upload' : 'by admin'} ${event.lockedAt ? 'on ' + new Date(event.lockedAt).toLocaleString() : ''}</div>
                  </div>
                </div>
              ` : `
                <div class="lock-status unlocked" style="margin-top: 20px;">
                  <span>üîì</span>
                  <div>
                    <div><strong>Event is Unlocked</strong></div>
                    <div>Squares can still be modified</div>
                  </div>
                </div>
              `}
            </div>
          `;
        } else {
          detailsContainer.innerHTML = `
            <div class="message error">
              Failed to load event details.
            </div>
          `;
        }
      } catch (err) {
        detailsContainer.innerHTML = `
          <div class="message error">
            Error loading event details: ${err.message}
          </div>
        `;
      }
    }

    function viewEvent(eventCode) {
      window.open(`index.html?event=${eventCode}`, '_blank');
    }

    function viewSelectedEvent() {
      if (currentSelectedEvent) {
        viewEvent(currentSelectedEvent);
      }
    }

    async function deleteEvent(eventCode) {
      if (!confirm(`Are you sure you want to delete the event "${eventCode}"? This action cannot be undone.`)) {
        return;
      }
      
      try {
        console.log('Attempting to delete event:', eventCode);
        
        const requestBody = { 
          code: eventCode
        };
        
        console.log('Delete request body:', requestBody);
        
        const response = await fetch(`${workerURL}admin/delete-event`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log('Delete response status:', response.status);
        console.log('Delete response headers:', response.headers);
        
        if (response.ok) {
          const result = await response.json();
          console.log('Delete successful:', result);
          showSuccessNotification('Event Deleted', `Event "${eventCode}" has been deleted`);
          loadAllEvents();
        } else {
          const error = await response.text();
          console.error('Delete failed with status:', response.status, 'Error:', error);
          showMessage(`Error deleting event (${response.status}): ${error}`, 'error');
        }
      } catch (err) {
        console.error('Delete error:', err);
        showMessage('Failed to delete event. Please try again.', 'error');
      }
    }

    function deleteSelectedEvent() {
      if (currentSelectedEvent) {
        deleteEvent(currentSelectedEvent).then(() => {
          backToAllEvents();
        });
      }
    }

    // Utility Functions
    function generateEventCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < 8; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function showMessage(message, type) {
      // Remove existing messages
      document.querySelectorAll('.message').forEach(msg => {
        if (!msg.closest('.validation-messages')) {
          msg.remove();
        }
      });
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      // Insert at the top of the current section
      const activeSection = document.querySelector('.section:not(.hidden)');
      if (activeSection) {
        activeSection.insertBefore(messageDiv, activeSection.firstChild.nextSibling);
      }
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    function showSuccessNotification(title, message) {
      const notification = document.getElementById('successNotification');
      document.getElementById('notificationTitle').textContent = title;
      document.getElementById('notificationMessage').textContent = message;
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }

    // Test function to debug squares saving
    function testSquaresSaving() {
      const squares = document.getElementById('squaresInput').value
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
      
      console.log('Current squares in textarea:', squares);
      console.log('Squares count:', squares.length);
      console.log('Current workflow data:', currentWorkflowData);
      
      // Test the exact data that would be sent to the server
      const testEventData = {
        ...currentWorkflowData.eventDetails,
        squares: squares,
        aiContext: currentWorkflowData.aiContext || {
          title: currentWorkflowData.eventDetails?.title || 'Test',
          names: '',
          theme: '',
          location: '',
          activities: '',
          otherInstructions: ''
        }
      };
      
      console.log('Test event data that would be sent:', testEventData);
      
      alert(`Squares count: ${squares.length}\nFirst square: "${squares[0] || 'None'}"\nLast square: "${squares[24] || 'None'}"\n\nCheck console for full data`);
    }
  </script>
</body>
</html>