<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EventBingo</title>
  <style>
    :root {
      --primary: #4a90e2;
      --secondary: #7b68ee;
      --accent: #ff6b6b;
      --success: #51cf66;
      --text-dark: #2c3e50;
      --text-light: #ffffff;
      --bg-light: rgba(255, 255, 255, 0.95);
      --bg-dark: rgba(44, 62, 80, 0.9);
      --instagram-pink: #E4405F;
      --instagram-purple: #833AB4;
      --instagram-orange: #F77737;
      --instagram-yellow: #FCAF45;
      --story-gradient: linear-gradient(45deg, var(--instagram-pink), var(--instagram-purple), var(--instagram-orange), var(--instagram-yellow));
    }

    html, body {
      font-family: 'Segoe UI', sans-serif;
      background: #fafafa;
      color: var(--text-dark);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      height: 100%;
    }

    /* Reset any potential conflicts */
    * {
      box-sizing: border-box;
    }

    /* Instagram-style Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: var(--bg-light);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .player-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 5px 0;
    }

    .player-scroll::-webkit-scrollbar {
      display: none;
    }

    .player-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--story-gradient);
      color: white;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
      flex-shrink: 0;
      position: relative;
    }

    .player-circle:hover {
      transform: scale(1.05);
    }

    .player-circle.active {
      border: 4px solid #ff0000;
      box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.3), 0 0 12px rgba(255, 0, 0, 0.5);
    }

    .player-circle::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: var(--story-gradient);
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .player-circle:hover::before {
      opacity: 1;
    }

    .player-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .player-name {
      font-size: 0.6rem;
      color: var(--text-dark);
      font-weight: 400;
      text-align: center;
      max-width: none; /* allow full name */
      overflow: visible; /* do not truncate */
      text-overflow: clip;
      white-space: normal; /* allow wrapping */
      line-height: 1.2;
    }

    body.dark-mode .player-name {
      color: #e0e0e0;
    }

    /* Ensure light-mode player names are visible in the top bar */
    .top-bar .player-name { color: #1f2937; }

    .share-icon {
      font-size: 1.5rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .share-icon:hover {
      background-color: rgba(0,0,0,0.1);
    }

    /* Main Content Area */
    .main-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 100px; /* Extra space for bottom nav */
      min-height: calc(100vh - 200px);
    }

    h1 {
      text-align: center;
      color: var(--text-light);
      font-size: 2.2rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-weight: bold;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
      background: var(--bg-light);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    select, input[type="text"], button {
      padding: 12px 16px;
      font-size: 1rem;
      margin: 8px;
      border-radius: 10px;
      border: 2px solid var(--primary);
      background: var(--bg-light);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2);
      transform: translateY(-1px);
    }

    /* Smooth transitions for input styling changes */
    input[type="text"] {
      transition: all 0.3s ease;
    }

    button {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-light);
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
    }

    .leaderboard {
      text-align: center;
      margin-top: 10px;
      font-size: 1rem;
      color: var(--accent);
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-spinner .spinner-container {
      background: var(--bg-light);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(74, 144, 226, 0.3);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-table {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-light);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }

    .main-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    @media (min-width: 769px) {
      .main-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        grid-template-rows: auto auto;
        gap: 20px;
      }
      
      .progress-table {
        grid-column: 2;
        grid-row: 1 / -1;
        position: sticky;
        top: 20px;
        height: fit-content;
      }
      
      .controls {
        grid-column: 1;
        grid-row: 1;
      }
      
      .grid {
        grid-column: 1;
        grid-row: 2;
      }
    }

    @media (max-width: 768px) {
      .progress-table {
        position: relative;
        top: auto;
        right: auto;
        margin: 0 auto 20px auto;
        max-width: 100%;
      }
    }

    .progress-table h3 {
      margin: 0 0 10px 0;
      color: var(--primary);
      font-size: 1rem;
    }

    .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid var(--gray);
    }

    .progress-row:last-child {
      border-bottom: none;
    }

    .progress-name {
      font-weight: bold;
      color: var(--text-dark);
    }

    .progress-count {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-light);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
      align-items: start;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      position: relative;
      padding: 20px;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .card:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .card::after {
      content: "📸";
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.2rem;
      opacity: 0.7;
      z-index: 10;
    }

    .card.completed::after {
      content: "✅";
      opacity: 1;
    }

    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }

    .card-photo {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .card p {
      margin: 0 0 15px 0;
      font-size: 1rem;
      line-height: 1.5;
      color: var(--text-dark);
      font-weight: 500;
    }

    input[type="file"] {
      margin-top: 5px;
      font-size: 0.9rem;
    }

    img {
      width: 100%;
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      border-radius: 12px;
      border: 3px solid var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: block;
    }

    img:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Clickable photo styling */
    img[onclick] {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    img[onclick]:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(74, 144, 226, 0.3);
    }

    img[onclick]:active {
      transform: scale(0.98);
    }

    /* Photo loading states */
    .photo-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      background: rgba(74, 144, 226, 0.1);
      border-radius: 12px;
      border: 2px dashed var(--primary);
      color: var(--primary);
      font-style: italic;
    }

    .photo-error {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 12px;
      border: 2px dashed var(--accent);
      color: var(--accent);
      font-style: italic;
    }

    /* Ensure photos maintain aspect ratio */
    .card-photo img {
      max-height: 400px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.5);
    }

    /* Add a subtle overlay to indicate clickability */
    .card-photo img[onclick]::after {
      content: "🔍 Click to view full size";
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .card-photo:hover img[onclick]::after {
      opacity: 1;
    }

    /* Photo link styling */
    .card-photo a {
      display: block;
      margin-bottom: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      padding: 8px 12px;
      background: rgba(74, 144, 226, 0.1);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .card-photo a:hover {
      background: rgba(74, 144, 226, 0.2);
      transform: translateY(-1px);
    }

    /* Upload section styling */
    .upload-section {
      margin-top: 15px;
      text-align: center;
    }

    .add-photo-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-light);
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }

    .add-photo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
    }

    .add-photo-btn:active {
      transform: translateY(0);
    }

    .add-icon {
      font-size: 1.2rem;
      font-weight: bold;
      line-height: 1;
    }

    .add-text {
      font-size: 0.95rem;
    }

    /* Hide upload section when photo is loaded */
    .upload-section.hidden {
      display: none;
    }

    /* Event Banner */
    .event-banner {
      background: var(--story-gradient);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 60px;
      z-index: 999;
      color: white;
    }

    .event-banner-info {
      flex: 1;
      min-width: 0;
    }

    .event-banner-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-banner-code {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    .event-banner-link {
      color: white;
      text-decoration: none;
      padding: 6px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      transition: background 0.2s;
      margin-left: 12px;
    }

    .event-banner-link:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Bottom Navigation Bar */
    .bottom-nav {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      width: 100vw !important;
      background: var(--bg-light);
      display: flex;
      justify-content: space-around;
      padding: 16px 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      z-index: 9999 !important;
      margin: 0 !important;
      border-top: 1px solid rgba(0,0,0,0.1);
      transform: translateZ(0);
    }

    /* Force bottom navigation to stay at bottom */
    .bottom-nav {
      position: fixed !important;
      bottom: 0 !important;
      top: auto !important;
      left: 0 !important;
      right: 0 !important;
      transform: none !important;
    }

    .nav-icon {
      font-size: 1.8rem;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 12px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 48px;
      min-height: 48px;
    }

    .nav-icon:hover {
      background-color: rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .nav-icon.active {
      background: var(--story-gradient);
      color: white;
      box-shadow: 0 4px 12px rgba(228, 64, 95, 0.3);
    }

    /* Compact Add Player button on very small screens */
    #addPlayerTopBtn {
      transition: all 0.2s ease;
    }
    @media (max-width: 420px) {
      #addPlayerTopBtn {
        padding: 8px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
      }
      #addPlayerTopBtn span { display: none; }
    }

    /* Carousel Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .carousel-content {
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .carousel-image {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .carousel-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2rem;
      color: white;
      cursor: pointer;
    }

    .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      pointer-events: none;
    }

    .carousel-prev,
    .carousel-next {
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      font-size: 2rem;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      pointer-events: all;
      transition: background-color 0.2s ease;
    }

    .carousel-prev:hover,
    .carousel-next:hover {
      background: rgba(0,0,0,0.7);
    }

    .carousel-counter {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    /* Leaderboard Modal - Dark Celebration Theme */
    .leaderboard-content {
      max-width: 90%;
      max-height: 90%;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      border-radius: 20px;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 2px solid #ffd700;
    }

    .leaderboard-close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 2rem;
      color: #ffd700;
      cursor: pointer;
      z-index: 10;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .leaderboard-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .leaderboard-header h2 {
      font-size: 2.5rem;
      color: #ffd700;
      margin: 0 0 10px 0;
      font-weight: bold;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
      background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .leaderboard-header p {
      color: #e0e0e0;
      margin: 0;
      font-size: 1.1rem;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .leaderboard-list {
      width: 100%;
      max-width: 500px;
      margin-bottom: 30px;
    }

    .leaderboard-entry {
      display: flex;
      align-items: center;
      padding: 20px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
      color: #ffffff;
    }

    .leaderboard-entry::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .leaderboard-entry:hover::before {
      left: 100%;
    }

    .leaderboard-entry:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .leaderboard-entry.first {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #000000;
      border-color: #ffd700;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    }

    .leaderboard-entry.first .player-name,
    .leaderboard-entry.first .player-title {
      color: #000000;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    .leaderboard-entry.second {
      background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
      color: #000000;
      border-color: #c0c0c0;
      box-shadow: 0 0 25px rgba(192, 192, 192, 0.4);
    }

    .leaderboard-entry.second .player-name,
    .leaderboard-entry.second .player-title {
      color: #000000;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    .leaderboard-entry.third {
      background: linear-gradient(135deg, #cd7f32, #daa520);
      color: #000000;
      border-color: #cd7f32;
      box-shadow: 0 0 20px rgba(205, 127, 50, 0.4);
    }

    .leaderboard-entry.third .player-name,
    .leaderboard-entry.third .player-title {
      color: #000000;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }

    .rank {
      font-size: 2rem;
      font-weight: bold;
      margin-right: 20px;
      min-width: 50px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
    }

    .player-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .player-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--story-gradient);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.3rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    .player-details {
      flex: 1;
    }

    .player-name {
      font-weight: bold;
      font-size: 1.3rem;
      margin-bottom: 5px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      color: #ffffff;
    }

    .player-title {
      font-size: 1rem;
      opacity: 0.9;
      font-style: italic;
      color: #e0e0e0;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
    }

    .leaderboard-stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      border: 1px solid rgba(255, 215, 0, 0.3);
      backdrop-filter: blur(10px);
    }

    .stat-number {
      display: block;
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 5px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #e0e0e0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .celebrate-button {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .celebrate-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
    }

    .celebrate-button:active {
      transform: translateY(-1px);
    }

    /* Fireworks animation */
    .fireworks {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      animation: firework-explode 2s ease-out infinite;
    }

    @keyframes firework-explode {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      50% {
        transform: scale(1);
        opacity: 0.8;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    /* Filter Bar */
    .filter-bar {
      background: white;
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-bar label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-weight: 500;
    }

    .filter-bar input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--instagram-pink);
    }

    /* Reactions */
    .reactions {
      display: flex;
      gap: 15px;
      padding: 10px 20px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }

    .reaction {
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .reaction:hover {
      transform: scale(1.2);
    }

    .reaction.active {
      transform: scale(1.3);
    }

    /* Dark Mode */
    body.dark-mode {
      background: #1a1a1a;
      color: #ffffff;
    }

    body.dark-mode .card {
      background: #2d2d2d;
      color: #ffffff;
      border: 1px solid #404040;
    }

    body.dark-mode .card p {
      color: #ffffff;
    }

    body.dark-mode .top-bar,
    body.dark-mode .bottom-nav,
    body.dark-mode .filter-bar {
      background: #2d2d2d;
      color: #ffffff;
      border: 1px solid #404040;
    }

    body.dark-mode .filter-bar label {
      color: #ffffff;
    }

    body.dark-mode .player-name {
      color: #ffffff;
    }

    body.dark-mode .upload-section {
      color: #ffffff;
    }

    body.dark-mode .add-photo-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #ffffff;
    }

    body.dark-mode .photo-loading,
    body.dark-mode .photo-error {
      color: #ffffff;
    }

    body.dark-mode .reactions {
      background: #404040;
      border-top: 1px solid #555555;
    }

    body.dark-mode .reaction {
      color: #ffffff;
    }

    /* Confetti Animation */
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3000;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--instagram-pink);
      animation: confetti-fall 3s linear infinite;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Instagram-style Top Bar -->
  <div class="top-bar">
    <div class="player-scroll" id="playerScroll">
      <!-- Player circles will be dynamically added here -->
    </div>
    <div style="display: flex; gap: 10px; align-items:center;">
      <button id="addPlayerTopBtn" title="Add new player" style="display:inline-flex; align-items:center; justify-content:center; gap:6px; padding: 8px 10px; border-radius: 9999px; border: 2px solid var(--instagram-pink); color: var(--instagram-pink); background: #fff; font-weight: 700; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">+
        <span style="font-size:0.85rem; font-weight:700;">Add Player</span>
      </button>
      <a href="info.html" style="font-size: 1.2rem; padding: 8px; border-radius: 50%; transition: background-color 0.2s ease; text-decoration: none; color: var(--text-dark);" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.1)'" onmouseout="this.style.backgroundColor='transparent'">ℹ️</a>
      <div class="share-icon" onclick="shareBingo()">🔗</div>
    </div>
  </div>

  <!-- Event Banner -->
  <div class="event-banner" id="eventBanner" style="display: none;">
    <div class="event-banner-info">
      <div class="event-banner-title" id="eventBannerTitle">Event Name</div>
      <div class="event-banner-code" id="eventBannerCode">Code: EVENT123</div>
    </div>
    <a href="info.html" class="event-banner-link">Change Event</a>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Filter Bar -->
    <div class="filter-bar">
      <label>
        <input type="checkbox" id="showCompletedOnly" onchange="toggleCompleted()">
        Show only completed squares
      </label>
      <label>
        <input type="checkbox" id="showOutstandingOnly" onchange="toggleOutstanding()">
        Show only outstanding squares
      </label>
    </div>
    
    <!-- Bingo Grid -->
    <div class="grid" id="bingoGrid"></div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-icon active" onclick="goHome()">🏠</div>
    <div class="nav-icon" onclick="openCarousel()">📸</div>
    <div class="nav-icon" onclick="openLeaderboard()">🥇</div>
    <a href="info.html" class="nav-icon">ℹ️</a>
    <div class="nav-icon" onclick="toggleDarkMode()">🌓</div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" class="modal">
    <div class="leaderboard-content">
      <div class="leaderboard-close" onclick="closeLeaderboard()">×</div>
      <div class="leaderboard-header">
        <h2>🎆 Bingo Boss Hall of Fame 🎆</h2>
        <p>Celebrating our photo challenge champions!</p>
      </div>
      <div id="leaderboardList" class="leaderboard-list">
        <!-- Leaderboard entries will be populated here -->
      </div>
      <button class="celebrate-button" onclick="celebrateLeaderboard()">
        🎉 Celebrate! 🎉
      </button>
    </div>
  </div>

  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-container">
      <div class="spinner"></div>
      <span>Loading...</span>
    </div>
  </div>

  <script>
    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'");
    }

    // Default squares for events without custom squares
    const defaultSquaresList = [
      "'n Ou foto saam met Anneke",
      "'n Foto van 'n vorige verjaarsdag of braai",
      "Die oudste selfie wat julle saam het",
      "Anneke wat kaalvoet loop (bonus: vuil voete)",
      "Anneke wat 'n bier drink (bonus: cheers oomblik)",
      "Iemand wat iets by Anneke leen",
      "Oliver wat saam met iemand bal speel",
      "Kesia saam met 'n 'tannie' of 'oom'",
      "Almal bymekaar om die kampvuur",
      "Anneke wat in vrede sit en lees",
      "Oggendkoffie in 'n beker wat nie aan jou behoort nie",
      "Oliver wat 'help' met iets",
      "'n Foto van die sonsondergang",
      "Iemand wat sukkel met kamp opslaan",
      "Anneke se lag vasgevang in 'n spontane foto",
      "'n Kamp speletjie of aktiwiteit",
      "'n Kreatiewe foto van bier of koffie (bonus: albei)",
      "Oliver op sy fiets",
      "'n Groepsfoto van almal",
      "Iemand wat iets soek wat verlore is (bv. foon, skoen, drankie)",
      "'n Foto wat gewys iets is geleen vir kamp",
      "Oliver wat iets in tee doop",
      "Anneke wat ontspan met 'n boek",
      "Kesia wat glimlag",
      "Almal wat totsiens waai by die vuir"
    ];

    let squares = [];



    const workerURL = "https://shy-recipe-5fb1.reinier-olivier.workers.dev/";
    const grid = document.getElementById("bingoGrid");
    const playerScroll = document.getElementById("playerScroll");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const carouselModal = document.getElementById("carouselModal");
    const carouselImage = document.getElementById("carouselImage");
    const carouselCaption = document.getElementById("carouselCaption");

    let currentPlayer = "";
    let allPhotos = [];
    let isDarkMode = false;
    let isMusicPlaying = false;
    let currentEvent = null;
    let hasPromptedForPlayer = false;
    const params = new URLSearchParams(window.location.search);
    let eventCode = params.get("event") || "default";

    // Instagram-style functions
    function selectPlayer(playerName) {
      currentPlayer = playerName;
      // Save last player for this event
      try { localStorage.setItem(`eventbingo:lastPlayer:${eventCode}`, playerName); } catch(_) {}
      updatePlayerCircles();
      createGrid();
      loadPhotos(currentPlayer);
      // Ensure the selected player is visible in the top bar immediately
      loadPlayers();
    }

    function updatePlayerCircles() {
      playerScroll.innerHTML = "";
      // This will be populated when we load players
    }

    function toggleReaction(index, emoji) {
      const reaction = document.querySelector(`#reactions${index} .reaction[onclick*="${emoji}"]`);
      reaction.classList.toggle('active');
    }

    function checkForCompletion() {
      const completedCards = document.querySelectorAll('.card.completed').length;
      if (completedCards === squares.length) {
        showConfetti();
        alert('🎉 Congratulations! You completed all squares! 🎉');
      }
    }

    function shareBingo() {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: 'EventBingo - Anneke word 35!!',
          text: 'Check out my EventBingo progress!',
          url: url
        });
      } else {
        navigator.clipboard.writeText(url).then(() => {
          alert('Link copied to clipboard!');
        });
      }
    }

    function goHome() {
      setActiveNavIcon(0);
      // Already on home view
    }


    function openCarousel() {
      setActiveNavIcon(2);
      showCarousel();
    }

    function openLeaderboard() {
      setActiveNavIcon(3);
      showLeaderboard();
    }

    function showLeaderboard() {
      const leaderboardModal = document.getElementById('leaderboardModal');
      leaderboardModal.classList.add('show');
      loadLeaderboardData();
    }

    function closeLeaderboard() {
      const leaderboardModal = document.getElementById('leaderboardModal');
      leaderboardModal.classList.remove('show');
    }

    async function loadLeaderboardData() {
      try {
        showLoading();
        const res = await fetch(`${workerURL}players?event=${eventCode}`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const players = await res.json();
        
        // Sort players by count (descending)
        players.sort((a, b) => b.count - a.count);
        
        // Populate leaderboard
        const leaderboardList = document.getElementById('leaderboardList');
        leaderboardList.innerHTML = '';
        
        if (players.length === 0) {
          leaderboardList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #e0e0e0;">
              <div style="font-size: 4rem; margin-bottom: 20px;">🎲</div>
              <h3 style="color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);">No Bingo Bosses Yet!</h3>
              <p>Start snapping photos to join the Hall of Fame!</p>
            </div>
          `;
          return;
        }
        
        players.forEach((player, index) => {
          const entry = document.createElement('div');
          entry.className = 'leaderboard-entry';
          
          // Add special styling for top 3
          if (index === 0) entry.classList.add('first');
          else if (index === 1) entry.classList.add('second');
          else if (index === 2) entry.classList.add('third');
          
          // Bingo gaming titles
          let title = '';
          if (index === 0) title = '🎯 Bingo Boss Supreme';
          else if (index === 1) title = '⭐ Photo Master';
          else if (index === 2) title = '🏅 Challenge Champion';
          else if (player.count >= 20) title = '🔥 Hot Streak Player';
          else if (player.count >= 15) title = '📸 Photo Pro';
          else if (player.count >= 10) title = '🎪 Rising Star';
          else if (player.count >= 5) title = '🌟 Getting Started';
          else title = '🎲 New Player';
          
          entry.innerHTML = `
            <div class="rank">${getRankEmoji(index + 1)}</div>
            <div class="player-info">
              <div class="player-avatar">${player.name.charAt(0).toUpperCase()}</div>
              <div class="player-details">
                <div class="player-name">${player.name}</div>
                <div class="player-title">${title}</div>
              </div>
            </div>
          `;
          
          leaderboardList.appendChild(entry);
        });
        
      } catch (err) {
        
        const leaderboardList = document.getElementById('leaderboardList');
        leaderboardList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ff6b6b;">
            <div style="font-size: 4rem; margin-bottom: 20px;">⚠️</div>
            <h3 style="color: #ffd700;">Oops! Something went wrong</h3>
            <p>Please try again later, Bingo Boss!</p>
          </div>
        `;
      } finally {
        hideLoading();
      }
    }

    function getRankEmoji(rank) {
      if (rank === 1) return '👑';
      if (rank === 2) return '🥈';
      if (rank === 3) return '🥉';
      if (rank <= 5) return '🏆';
      if (rank <= 10) return '🎖️';
      return '🎯';
    }

    function celebrateLeaderboard() {
      // Trigger confetti
      showConfetti();
      
      // Add fireworks effect
      createFireworks();
      
      // Play celebration sound (if available)
      playCelebrationSound();
    }

    function createFireworks() {
      const leaderboardContent = document.querySelector('.leaderboard-content');
      const fireworks = document.createElement('div');
      fireworks.className = 'fireworks';
      
      // Create multiple fireworks
      for (let i = 0; i < 20; i++) {
        const firework = document.createElement('div');
        firework.className = 'firework';
        firework.style.left = Math.random() * 100 + '%';
        firework.style.top = Math.random() * 100 + '%';
        firework.style.backgroundColor = ['#ffd700', '#ff6b6b', '#4a90e2', '#51cf66', '#ff8e8e'][Math.floor(Math.random() * 5)];
        firework.style.animationDelay = Math.random() * 2 + 's';
        fireworks.appendChild(firework);
      }
      
      leaderboardContent.appendChild(fireworks);
      
      // Remove fireworks after animation
      setTimeout(() => {
        if (fireworks.parentNode) {
          fireworks.parentNode.removeChild(fireworks);
        }
      }, 3000);
    }

    function playCelebrationSound() {
      // Create a simple celebration sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (err) {
        
      }
    }

    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      setActiveNavIcon(isDarkMode ? 3 : -1);
    }

    function toggleMusic() {
      isMusicPlaying = !isMusicPlaying;
      setActiveNavIcon(isMusicPlaying ? 4 : -1);
      // Could implement background music here
      
    }

    function setActiveNavIcon(index) {
      document.querySelectorAll('.nav-icon').forEach((icon, i) => {
        icon.classList.toggle('active', i === index);
      });
    }

    // Remove search from nav icon indices
    function goHome() {
      setActiveNavIcon(0);
    }

    function openCarousel() {
      setActiveNavIcon(1);
      showCarousel();
    }

    function openLeaderboard() {
      setActiveNavIcon(2);
      showLeaderboard();
    }

    function showCarousel() {
      carouselModal.classList.add('show');
      // Load all photos for carousel
      loadAllPhotosForCarousel();
    }

    function closeCarousel() {
      carouselModal.classList.remove('show');
    }

    function loadAllPhotosForCarousel() {
      // Collect all uploaded photos from the current view
      const allImages = document.querySelectorAll('.card-photo img');
      const photos = [];
      
      allImages.forEach((img, index) => {
        if (img.src && img.src !== '') {
          photos.push({
            src: img.src,
            alt: img.alt || `Photo ${index + 1}`,
            caption: img.alt || `Photo ${index + 1}`
          });
        }
      });
      
      if (photos.length === 0) {
        carouselCaption.textContent = 'No photos uploaded yet. Start completing challenges to see them here!';
        carouselImage.style.display = 'none';
        return;
      }
      
      // Show first photo
      let currentPhotoIndex = 0;
      showPhotoInCarousel(photos[currentPhotoIndex]);
      
      // Add navigation controls
      carouselContent.innerHTML = `
        <div class="carousel-close" onclick="closeCarousel()">×</div>
        <div class="carousel-nav">
          <button class="carousel-prev" onclick="previousPhoto()" ${photos.length <= 1 ? 'style="display:none"' : ''}>‹</button>
          <button class="carousel-next" onclick="nextPhoto()" ${photos.length <= 1 ? 'style="display:none"' : ''}>›</button>
        </div>
        <img id="carouselImage" class="carousel-image" src="" alt="">
        <div id="carouselCaption"></div>
        <div class="carousel-counter">${currentPhotoIndex + 1} / ${photos.length}</div>
      `;
      
      // Update references after recreating elements
      carouselImage = document.getElementById('carouselImage');
      carouselCaption = document.getElementById('carouselCaption');
      
      // Global variables for navigation
      window.carouselPhotos = photos;
      window.currentPhotoIndex = currentPhotoIndex;
      
      function showPhotoInCarousel(photo) {
        carouselImage.src = photo.src;
        carouselImage.alt = photo.alt;
        carouselCaption.textContent = photo.caption;
        carouselImage.style.display = 'block';
      }
      
      // Navigation functions
      window.nextPhoto = function() {
        if (window.carouselPhotos && window.carouselPhotos.length > 1) {
          window.currentPhotoIndex = (window.currentPhotoIndex + 1) % window.carouselPhotos.length;
          showPhotoInCarousel(window.carouselPhotos[window.currentPhotoIndex]);
          updateCounter();
        }
      };
      
      window.previousPhoto = function() {
        if (window.carouselPhotos && window.carouselPhotos.length > 1) {
          window.currentPhotoIndex = (window.currentPhotoIndex - 1 + window.carouselPhotos.length) % window.carouselPhotos.length;
          showPhotoInCarousel(window.carouselPhotos[window.currentPhotoIndex]);
          updateCounter();
        }
      };
      
      function updateCounter() {
        const counter = document.querySelector('.carousel-counter');
        if (counter) {
          counter.textContent = `${window.currentPhotoIndex + 1} / ${window.carouselPhotos.length}`;
        }
      }
      
      // Keyboard navigation
      document.addEventListener('keydown', function(e) {
        if (carouselModal.classList.contains('show')) {
          if (e.key === 'ArrowLeft') previousPhoto();
          if (e.key === 'ArrowRight') nextPhoto();
          if (e.key === 'Escape') closeCarousel();
        }
      });
    }

    function toggleCompleted() {
      const showCompletedOnly = document.getElementById('showCompletedOnly').checked;
      const showOutstandingOnly = document.getElementById('showOutstandingOnly');
      
      // If completed is checked, uncheck outstanding
      if (showCompletedOnly) {
        showOutstandingOnly.checked = false;
      }
      
      const cards = document.querySelectorAll('.card');
      
      cards.forEach(card => {
        const hasPhoto = card.querySelector('img');
        if (showCompletedOnly) {
          card.style.display = hasPhoto ? 'block' : 'none';
        } else {
          card.style.display = 'block';
        }
      });
    }

    function toggleOutstanding() {
      const showOutstandingOnly = document.getElementById('showOutstandingOnly').checked;
      const showCompletedOnly = document.getElementById('showCompletedOnly');
      
      // If outstanding is checked, uncheck completed
      if (showOutstandingOnly) {
        showCompletedOnly.checked = false;
      }
      
      const cards = document.querySelectorAll('.card');
      
      cards.forEach(card => {
        const hasPhoto = card.querySelector('img');
        if (showOutstandingOnly) {
          card.style.display = hasPhoto ? 'none' : 'block';
        } else {
          card.style.display = 'block';
        }
      });
    }

    function showConfetti() {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      
      for (let i = 0; i < 50; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left = Math.random() * 100 + '%';
        piece.style.animationDelay = Math.random() * 3 + 's';
        piece.style.backgroundColor = ['#E4405F', '#833AB4', '#F77737', '#FCAF45'][Math.floor(Math.random() * 4)];
        confetti.appendChild(piece);
      }
      
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3000);
    }

    function showLoading() {
      
      loadingSpinner.style.display = "block";
    }

    function hideLoading() {
      
      loadingSpinner.style.display = "none";
    }

    function createGrid() {
      grid.innerHTML = "";
      squares.forEach((square, index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="card-content">
            <p>${square}</p>
            <div class="upload-section" id="upload${index}">
              <button class="add-photo-btn" id="btn${index}">
                <span class="add-icon">+</span>
                <span class="add-text">Add Photo</span>
              </button>
              <input type="file" id="file${index}" accept="image/*" style="display: none;" />
            </div>
          </div>
          <div class="card-photo" id="result${index}"></div>
          <div class="reactions" id="reactions${index}">
            <span class="reaction" onclick="toggleReaction(${index}, '❤️')">❤️</span>
            <span class="reaction" onclick="toggleReaction(${index}, '😂')">😂</span>
            <span class="reaction" onclick="toggleReaction(${index}, '🔥')">🔥</span>
            <span class="reaction" onclick="toggleReaction(${index}, '🙌')">🙌</span>
          </div>
        `;
        grid.appendChild(div);

        const fileInput = div.querySelector(`#file${index}`);
        const resultDiv = div.querySelector(`#result${index}`);
        const uploadSection = div.querySelector(`#upload${index}`);
        const addPhotoBtn = div.querySelector(`#btn${index}`);

        // Initially hide upload section if there's already a photo
        if (resultDiv.innerHTML.trim() !== "") {
          uploadSection.classList.add('hidden');
        }

        // Handle button click to trigger file input
        addPhotoBtn.addEventListener("click", () => {
          fileInput.click();
        });

        fileInput.addEventListener("change", async (e) => {
          if (!currentPlayer) {
            const selected = await promptForPlayerSelection();
            if (!selected) {
              e.target.value = ""; // Clear file input
              return;
            }
            currentPlayer = selected;
          }
          const file = e.target.files[0];
          if (!file) return;

            const formData = new FormData();
            formData.append("file", file);
            formData.append("player", currentPlayer);
            formData.append("square", square);
            formData.append("event", eventCode);

          resultDiv.innerHTML = '<div class="photo-loading">Uploading photo...</div>';
          showLoading();

          try {
            const res = await fetch(workerURL, { method: "POST", body: formData });
            const data = await res.json();
            if (data.url) {
              resultDiv.innerHTML = `
                <img src="${data.url}" alt="Uploaded photo" onclick="window.open('${escapeQuotes(data.url)}', '_blank')" style="cursor: pointer; opacity:0; transition: opacity 0.3s ease;" onload="this.style.opacity='1'" />
              `;
              // Hide the upload section since photo is now loaded
              uploadSection.classList.add('hidden');
              div.classList.add('completed');
              updateProgress();
              updateLeaderboard();
              // Check if player completed all squares for confetti
              checkForCompletion();
              // Refresh player list to include new players and update progress table
              // Don't await to avoid blocking the UI
              loadPlayers().catch(() => {});
            } else {
              resultDiv.innerHTML = '<div class="photo-error">Upload failed. Please try again.</div>';
            }
          } catch (err) {
            resultDiv.innerHTML = '<div class="photo-error">Error uploading photo. Please try again.</div>';
          } finally {
            hideLoading();
          }
        });
      });
    }

    async function loadPlayers() {
      try {
        showLoading();
        const res = await fetch(`${workerURL}players?event=${eventCode}`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const players = await res.json();
        
        // Update player circles in top bar
        playerScroll.innerHTML = "";

        // Build a list including the current player (ensure appears even with 0 photos)
        const names = [...players.map(p => p.name)];
        if (currentPlayer && !names.includes(currentPlayer)) {
          players.unshift({ name: currentPlayer, count: 0 });
        }

        // Helper to generate unique 1-2 letter labels for circles
        const usedLabels = new Set();
        function getCircleLabel(name) {
          const parts = name.trim().split(/\s+/);
          let label = parts.length >= 2 ? (parts[0][0] + parts[1][0]) : (name.slice(0, 2));
          label = (label || '?').toUpperCase();
          // Resolve collisions by using next character if available
          let i = 2;
          while (usedLabels.has(label) && i < name.length) {
            label = (name[0] + name[i]).toUpperCase();
            i++;
          }
          if (usedLabels.has(label)) {
            // Fallback to appending a dot to differentiate
            let n = 1;
            while (usedLabels.has(label + n)) n++;
            label = label + n;
          }
          usedLabels.add(label);
          return label;
        }

        // Render players
        players.forEach(player => {
          const playerItem = document.createElement("div");
          playerItem.className = "player-item";
          
          const circle = document.createElement("div");
          circle.className = "player-circle";
          circle.textContent = getCircleLabel(player.name);
          circle.title = player.name;
          circle.onclick = () => selectPlayer(player.name);
          if (player.name === currentPlayer) {
            circle.classList.add('active');
          }
          
          const name = document.createElement("div");
          name.className = "player-name";
          name.textContent = player.name;
          
          playerItem.appendChild(circle);
          playerItem.appendChild(name);
          playerScroll.appendChild(playerItem);
        });
        // If no player selected yet and we haven't prompted on load, we rely on the on-load prompt
        
      } catch (err) {
        
      } finally {
        hideLoading();
      }
    }

    function updateProgressTable(players) {
      if (players.length === 0) {
        progressTable.style.display = "none";
        return;
      }
      
      progressTable.style.display = "block";
      progressList.innerHTML = "";
      
      // Sort players by count (descending)
      players.sort((a, b) => b.count - a.count);
      
      players.forEach(player => {
        const row = document.createElement("div");
        row.className = "progress-row";
        row.innerHTML = `
          <span class="progress-name">${player.name}</span>
          <span class="progress-count">${player.count}/${squares.length}</span>
        `;
        progressList.appendChild(row);
      });
    }

    async function loadPhotos(player) {
      try {
        showLoading();
        const res = await fetch(`${workerURL}player?name=${encodeURIComponent(player)}&event=${eventCode}`);
        const data = await res.json();
        squares.forEach((square, index) => {
          const resultDiv = document.getElementById(`result${index}`);
          const uploadSection = document.getElementById(`upload${index}`);
          const card = resultDiv.closest('.card');
          const url = data[square];
          if (url) {
            resultDiv.innerHTML = `
              <img src="${url}" alt="${escapeQuotes(square)}" onclick="window.open('${escapeQuotes(url)}', '_blank')" style="cursor: pointer; opacity:0; transition: opacity 0.3s ease;" onload="this.style.opacity='1'" />
            `;
            // Hide the upload section since photo is already loaded
            if (uploadSection) {
              uploadSection.classList.add('hidden');
            }
            // Mark card as completed
            if (card) {
              card.classList.add('completed');
            }
          } else {
            resultDiv.innerHTML = "";
            // Show the upload section if no photo is loaded
            if (uploadSection) {
              uploadSection.classList.remove('hidden');
            }
            // Remove completed class
            if (card) {
              card.classList.remove('completed');
            }
          }
        });
        updateProgress();
        // Refresh progress table after loading photos
        loadPlayers();
      } catch (err) {
        
        // Clear all photo displays on error
        squares.forEach((square, index) => {
          const resultDiv = document.getElementById(`result${index}`);
          resultDiv.innerHTML = "";
        });
      } finally {
        hideLoading();
      }
    }

    async function updateProgress() {
      const filled = [...document.querySelectorAll("[id^='result'] img")].length;
      // Note: progressDisplay element not in HTML - function kept for compatibility
      if (typeof progressDisplay !== 'undefined') {
        progressDisplay.textContent = `${currentPlayer} has completed ${filled} of ${squares.length} squares.`;
      }
    }

    async function updateLeaderboard() {
      // Note: leaderDisplay element not in HTML - function kept for compatibility
      if (typeof leaderDisplay !== 'undefined') {
        const res = await fetch(`${workerURL}leader?event=${eventCode}`);
        const data = await res.json();
        leaderDisplay.textContent = data.name
          ? `🏆 Leader: ${data.name} (${data.count}/${squares.length})`
          : "";
      }
    }

    // Prompt for player selection or new player
    async function promptForPlayerSelection() {
      return new Promise(async (resolve) => {
        try {
          // Fetch current players
          const res = await fetch(`${workerURL}players?event=${eventCode}`);
          const players = await res.json();
          
          // Create modal for player selection
          const modal = document.createElement("div");
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
          `;
          
          const content = document.createElement("div");
          const isDark = document.body.classList.contains('dark-mode');
          content.style.cssText = `
            background: ${isDark ? '#1f2937' : 'linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95))'};
            color: ${isDark ? '#ffffff' : '#1f2937'};
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 2px solid rgba(228, 64, 95, 0.2);
          `;
          
          // Check for last player in localStorage
          let lastPlayer = '';
          try {
            lastPlayer = localStorage.getItem(`eventbingo:lastPlayer:${eventCode}`) || '';
          } catch (_) {}
          
          let html = `
            <h2 style="margin-top: 0; ${isDark ? 'color:#fff;' : 'color:#1f2937;'} background: var(--story-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.5rem; margin-bottom: 20px;">Select a Player</h2>`;
          
          // Show "Continue as last player" if available
          if (lastPlayer) {
            html += `
              <div id="continueLastPlayer" style="
                padding: 15px;
                margin-bottom: 15px;
                background: linear-gradient(135deg, #10b981, #34d399);
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
              " onclick="selectPlayerOption('${escapeQuotes(lastPlayer)}')">
                <div style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  background: rgba(255,255,255,0.3);
                  color: white;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-weight: bold;
                  font-size: 1.2rem;
                ">${lastPlayer.charAt(0).toUpperCase()}</div>
                <div style="flex:1; color: white;">
                  <div style="font-weight: 600; font-size: 1rem;">↩️ Continue as ${escapeQuotes(lastPlayer)}</div>
                  <div style="font-size: 0.85rem; opacity: 0.9;">Your previous session</div>
                </div>
              </div>
            `;
          }
          
          if (players.length > 0) {
            html += '<div style="margin-bottom: 20px;">';
            players.forEach(player => {
              html += `
                <div class="player-option" style="
                  padding: 15px;
                  margin-bottom: 10px;
                  border: 2px solid #e0e0e0;
                  border-radius: 10px;
                  cursor: pointer;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  gap: 15px;
                  color: ${isDark ? '#ffffff' : '#1f2937'};
                  background: ${isDark ? 'rgba(255,255,255,0.05)' : '#ffffff'};
                " onclick="selectPlayerOption('${escapeQuotes(player.name)}')">
                  <div style="
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    background: var(--story-gradient);
                    color: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 1.3rem;
                  ">${player.name.charAt(0).toUpperCase()}</div>
                  <div>
                    <div style="font-weight: 600; font-size: 1.05rem; ${isDark ? 'color:#fff;' : 'color:#1f2937;'}">${player.name}</div>
                    <div style="${isDark ? 'color: #e5e7eb;' : 'color:#6b7280;'} font-size: 0.9rem;">${player.count} photos</div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += `
            <div style="
              padding: 15px;
              border: 2px dashed var(--primary);
              border-radius: 10px;
              cursor: pointer;
              transition: all 0.2s ease;
              text-align: center;
              font-weight: bold;
              color: var(--primary);
            " onclick="selectNewPlayer()">
              <span style="font-size: 1.5rem;">+</span> Add New Player
            </div>
            <button onclick="closePlayerModal()" style="
              margin-top: 20px;
              width: 100%;
              padding: 12px;
              border: none;
              background: #ccc;
              border-radius: 10px;
              cursor: pointer;
              font-weight: bold;
            ">Cancel</button>
          `;
          
          content.innerHTML = html;
          modal.appendChild(content);
          document.body.appendChild(modal);
          
          // Store modal reference globally for inline onclick handlers
          window.playerSelectionModal = modal;
          window.playerSelectionResolve = resolve;
          
          // Close modal when clicking outside
          modal.onclick = (e) => {
            if (e.target === modal) {
              closePlayerModal();
            }
          };
          
          // Add hover effects
          const playerOptions = content.querySelectorAll('.player-option');
          playerOptions.forEach(option => {
            option.onmouseover = () => {
              option.style.borderColor = 'var(--primary)';
              option.style.transform = 'scale(1.02)';
            };
            option.onmouseout = () => {
              option.style.borderColor = '#e0e0e0';
              option.style.transform = 'scale(1)';
            };
          });
          
        } catch (err) {
          
          // Fallback to simple prompt
          const playerName = prompt("Enter player name:");
          if (playerName && playerName.trim()) {
            resolve(playerName.trim());
          } else {
            resolve(null);
          }
        }
      });
    }
    
    // Helper functions for player selection modal
    function selectPlayerOption(playerName) {
      selectPlayer(playerName); // This will update current player and load photos
      closePlayerModal();
      if (window.playerSelectionResolve) {
        window.playerSelectionResolve(playerName);
        window.playerSelectionResolve = null;
      }
    }
    
    function selectNewPlayer() {
      closePlayerModal();
      addNewPlayer().then(name => {
        if (window.playerSelectionResolve && name) {
          window.playerSelectionResolve(name);
          window.playerSelectionResolve = null;
        }
      });
    }
    
    function closePlayerModal() {
      if (window.playerSelectionModal && window.playerSelectionModal.parentNode) {
        window.playerSelectionModal.parentNode.removeChild(window.playerSelectionModal);
        window.playerSelectionModal = null;
      }
      if (window.playerSelectionResolve) {
        window.playerSelectionResolve(null);
        window.playerSelectionResolve = null;
      }
    }
    
    // Add new player functionality (simplified for Instagram-style)
    function addNewPlayer() {
      return new Promise((resolve) => {
        const playerName = prompt("Enter new player name:");
        if (playerName && playerName.trim()) {
          currentPlayer = playerName.trim();
          try { localStorage.setItem(`eventbingo:lastPlayer:${eventCode}`, currentPlayer); } catch(_) {}
          createGrid();
          loadPhotos(currentPlayer);
          loadPlayers(); // Refresh player list (ensures immediate circle render)
          resolve(playerName.trim());
        } else {
          resolve(null);
        }
      });
    }

    // Test worker connection
    async function testWorkerConnection() {
      try {
        
        const res = await fetch(workerURL);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const text = await res.text();
        
        return true;
      } catch (err) {
        
        
        // Show user-friendly error message with deployment instructions
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #ff6b6b;
          color: white;
          padding: 20px 25px;
          border-radius: 10px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          z-index: 10000;
          font-weight: 600;
          text-align: center;
          max-width: 90%;
        `;
        errorDiv.innerHTML = `
          ⚠️ EventBingo Worker Not Deployed<br>
          <small style="font-size: 0.9em; margin-top: 10px; display: block;">
            The worker needs to be deployed to Cloudflare Workers.<br>
            Check the EventBingo/worker.js file and deploy it to your Cloudflare account.
          </small>
        `;
        document.body.appendChild(errorDiv);
        
        // Auto-hide after 8 seconds (longer for instructions)
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 8000);
        
        return false;
      }
    }

    // Initialize app
    createGrid();
    

    testWorkerConnection().then(connected => {
      if (connected) {
        loadPlayers();
        updateLeaderboard();
      } else {
        
      }
    });

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      // If no event parameter, guide users to info page first
      const urlParams = new URLSearchParams(window.location.search);
      const hasEvent = urlParams.has('event');
      if (!hasEvent) {
        // Preserve any potential referral info if present
        window.location.replace('info.html');
        return;
      }

      // Get event code from URL parameters
      eventCode = urlParams.get('event') || 'default';
      
      // Load event information
      loadEventInfo();

      // Wire up always-visible Add Player button on the right
      const addPlayerTopBtn = document.getElementById('addPlayerTopBtn');
      if (addPlayerTopBtn) {
        addPlayerTopBtn.addEventListener('click', async () => {
          const selected = await promptForPlayerSelection();
          if (selected) {
            currentPlayer = selected;
            createGrid();
            loadPhotos(currentPlayer);
            loadPlayers();
            hasPromptedForPlayer = true;
          }
        });
      }

      // Prompt immediately on page load if no player is selected yet
      setTimeout(async () => {
        if (!currentPlayer && !hasPromptedForPlayer) {
          hasPromptedForPlayer = true;
          const name = await promptForPlayerSelection();
          if (name) {
            currentPlayer = name;
            createGrid();
            loadPhotos(currentPlayer);
            loadPlayers();
          }
        }
      }, 300);
    });

    async function loadEventInfo() {
      try {
        const res = await fetch(`${workerURL}event-info?event=${eventCode}`);
        if (res.ok) {
          currentEvent = await res.json();
          squares = currentEvent.squares || [];
          
          createGrid();
          updateEventDisplay();
        }
      } catch (err) {
        
        currentEvent = {
          title: "EventBingo",
          description: "A fun photo challenge game!",
          code: "default"
        };
        squares = defaultSquaresList; // fallback
        
        createGrid();
        updateEventDisplay();

      }
    }

    function updateEventDisplay() {
      if (currentEvent) {
        // Update page title
        document.title = `${currentEvent.title} - EventBingo`;
        
        // Update event banner
        const banner = document.getElementById('eventBanner');
        const bannerTitle = document.getElementById('eventBannerTitle');
        const bannerCode = document.getElementById('eventBannerCode');
        if (banner && bannerTitle && bannerCode) {
          bannerTitle.textContent = currentEvent.title;
          bannerCode.textContent = `Code: ${currentEvent.code}`;
          banner.style.display = 'flex';
        }
      }
    }
</script>