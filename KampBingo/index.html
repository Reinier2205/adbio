<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EventBingo</title>
  <style>
    :root {
      --primary: #4a90e2;
      --secondary: #7b68ee;
      --accent: #ff6b6b;
      --success: #51cf66;
      --text-dark: #2c3e50;
      --text-light: #ffffff;
      --bg-light: rgba(255, 255, 255, 0.95);
      --bg-dark: rgba(44, 62, 80, 0.9);
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text-dark);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: var(--text-light);
      font-size: 2.2rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-weight: bold;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
      background: var(--bg-light);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    select, input[type="text"], button {
      padding: 12px 16px;
      font-size: 1rem;
      margin: 8px;
      border-radius: 10px;
      border: 2px solid var(--primary);
      background: var(--bg-light);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2);
      transform: translateY(-1px);
    }

    button {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-light);
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
    }

    .leaderboard {
      text-align: center;
      margin-top: 10px;
      font-size: 1rem;
      color: var(--accent);
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-spinner .spinner-container {
      background: var(--bg-light);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(74, 144, 226, 0.3);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-table {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-light);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }

    .main-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    @media (min-width: 769px) {
      .main-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        grid-template-rows: auto auto;
        gap: 20px;
      }
      
      .progress-table {
        grid-column: 2;
        grid-row: 1 / -1;
        position: sticky;
        top: 20px;
        height: fit-content;
      }
      
      .controls {
        grid-column: 1;
        grid-row: 1;
      }
      
      .grid {
        grid-column: 1;
        grid-row: 2;
      }
    }

    @media (max-width: 768px) {
      .progress-table {
        position: relative;
        top: auto;
        right: auto;
        margin: 0 auto 20px auto;
        max-width: 100%;
      }
    }

    .progress-table h3 {
      margin: 0 0 10px 0;
      color: var(--primary);
      font-size: 1rem;
    }

    .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid var(--gray);
    }

    .progress-row:last-child {
      border-bottom: none;
    }

    .progress-name {
      font-weight: bold;
      color: var(--text-dark);
    }

    .progress-count {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-light);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
      align-items: start;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

    .card {
      background: var(--bg-light);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-left: 6px solid var(--primary);
      backdrop-filter: blur(10px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      min-height: fit-content;
      height: auto;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card-photo {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .card p {
      margin-bottom: 10px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    input[type="file"] {
      margin-top: 5px;
      font-size: 0.9rem;
    }

    img {
      width: 100%;
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      border-radius: 12px;
      border: 3px solid var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: block;
    }

    img:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Clickable photo styling */
    img[onclick] {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    img[onclick]:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(74, 144, 226, 0.3);
    }

    img[onclick]:active {
      transform: scale(0.98);
    }

    /* Photo loading states */
    .photo-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      background: rgba(74, 144, 226, 0.1);
      border-radius: 12px;
      border: 2px dashed var(--primary);
      color: var(--primary);
      font-style: italic;
    }

    .photo-error {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 12px;
      border: 2px dashed var(--accent);
      color: var(--accent);
      font-style: italic;
    }

    /* Ensure photos maintain aspect ratio */
    .card-photo img {
      max-height: 400px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.5);
    }

    /* Add a subtle overlay to indicate clickability */
    .card-photo img[onclick]::after {
      content: "üîç Click to view full size";
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .card-photo:hover img[onclick]::after {
      opacity: 1;
    }

    /* Photo link styling */
    .card-photo a {
      display: block;
      margin-bottom: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      padding: 8px 12px;
      background: rgba(74, 144, 226, 0.1);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .card-photo a:hover {
      background: rgba(74, 144, 226, 0.2);
      transform: translateY(-1px);
    }

    /* Upload section styling */
    .upload-section {
      margin-top: 15px;
      text-align: center;
    }

    .add-photo-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: var(--text-light);
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
    }

    .add-photo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
    }

    .add-photo-btn:active {
      transform: translateY(0);
    }

    .add-icon {
      font-size: 1.2rem;
      font-weight: bold;
      line-height: 1;
    }

    .add-text {
      font-size: 0.95rem;
    }

    /* Hide upload section when photo is loaded */
    .upload-section.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>EventBingo ‚Äì Anneke word 35!!</h1>

  <div class="main-container">
    <div class="progress-table" id="progressTable" style="display: none;">
      <h3>üèÜ Progress</h3>
      <div id="progressList"></div>
    </div>

    <div class="controls">
      <select id="playerSelect">
        <option value="">-- Choose a player --</option>
      </select>
      <br>
      <input type="text" id="newPlayerInput" placeholder="Or enter a new name" />
      <div id="progressDisplay"></div>
      <div class="leaderboard" id="leaderDisplay"></div>
    </div>

    <div class="grid" id="bingoGrid"></div>
  </div>

  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-container">
      <div class="spinner"></div>
      <span>Loading...</span>
    </div>
  </div>

  <script>
    const squares = [
  "'n Ou foto saam met Anneke",
  "'n Foto van 'n vorige verjaarsdag of braai",
  "Die oudste selfie wat julle saam het",
  "Anneke wat kaalvoet loop (bonus: vuil voete)",
  "Anneke wat 'n bier drink (bonus: cheers oomblik)",
  "Iemand wat iets by Anneke leen",
  "Oliver wat saam met iemand bal speel",
  "Kesia saam met 'n 'tannie' of 'oom'",
  "Almal bymekaar om die kampvuur",
  "Anneke wat in vrede sit en lees",
  "Oggendkoffie in 'n beker wat nie aan jou behoort nie",
  "Oliver wat 'help' met iets",
  "'n Foto van die sonsondergang",
  "Iemand wat sukkel met kamp opslaan",
  "Anneke se lag vasgevang in 'n spontane foto",
  "'n Kamp speletjie of aktiwiteit",
  "'n Kreatiewe foto van bier of koffie (bonus: albei)",
  "Oliver op sy fiets",
  "'n Groepsfoto van almal",
  "Iemand wat iets soek wat verlore is (bv. foon, skoen, drankie)",
  "'n Foto wat gewys iets is geleen vir kamp",
  "Oliver wat iets in tee doop",
  "Anneke wat ontspan met 'n boek",
  "Kesia wat glimlag",
  "Almal wat totsiens waai by die vuur"];



    const workerURL = "https://rapid-hill-7b92.reinier-olivier.workers.dev/";
    const grid = document.getElementById("bingoGrid");
    const playerSelect = document.getElementById("playerSelect");
    const newPlayerInput = document.getElementById("newPlayerInput");
    const progressDisplay = document.getElementById("progressDisplay");
    const leaderDisplay = document.getElementById("leaderDisplay");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const progressTable = document.getElementById("progressTable");
    const progressList = document.getElementById("progressList");

    let currentPlayer = "";

    function showLoading() {
      console.log("Showing loading spinner");
      loadingSpinner.style.display = "block";
    }

    function hideLoading() {
      console.log("Hiding loading spinner");
      loadingSpinner.style.display = "none";
    }

    function createGrid() {
      grid.innerHTML = "";
      squares.forEach((square, index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="card-content">
            <p>${square}</p>
            <div class="upload-section" id="upload${index}">
              <button class="add-photo-btn" id="btn${index}">
                <span class="add-icon">+</span>
                <span class="add-text">Add Photo</span>
              </button>
              <input type="file" id="file${index}" accept="image/*" style="display: none;" />
            </div>
          </div>
          <div class="card-photo" id="result${index}"></div>
        `;
        grid.appendChild(div);

        const fileInput = div.querySelector(`#file${index}`);
        const resultDiv = div.querySelector(`#result${index}`);
        const uploadSection = div.querySelector(`#upload${index}`);
        const addPhotoBtn = div.querySelector(`#btn${index}`);

        // Initially hide upload section if there's already a photo
        if (resultDiv.innerHTML.trim() !== "") {
          uploadSection.classList.add('hidden');
        }

        // Handle button click to trigger file input
        addPhotoBtn.addEventListener("click", () => {
          fileInput.click();
        });

        fileInput.addEventListener("change", async (e) => {
          if (!currentPlayer) return alert("Select or enter your name first.");
          const file = e.target.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);
          formData.append("player", currentPlayer);
          formData.append("square", square);

          resultDiv.innerHTML = '<div class="photo-loading">Uploading photo...</div>';
          showLoading();

          try {
            const res = await fetch(workerURL, { method: "POST", body: formData });
            const data = await res.json();
            if (data.url) {
              resultDiv.innerHTML = `
                <img src="${data.url}" alt="Uploaded photo" onclick="window.open('${data.url}', '_blank')" style="cursor: pointer; opacity:0; transition: opacity 0.3s ease;" onload="this.style.opacity='1'" />
              `;
              // Hide the upload section since photo is now loaded
              uploadSection.classList.add('hidden');
              updateProgress();
              updateLeaderboard();
              // Refresh player list to include new players and update progress table
              loadPlayers();
            } else {
              resultDiv.innerHTML = '<div class="photo-error">Upload failed. Please try again.</div>';
            }
          } catch (err) {
            resultDiv.innerHTML = '<div class="photo-error">Error uploading photo. Please try again.</div>';
          } finally {
            hideLoading();
          }
        });
      });
    }

    async function loadPlayers() {
      try {
        showLoading();
        const res = await fetch(`${workerURL}players`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const players = await res.json();
        
        // Clear existing options except the first one
        playerSelect.innerHTML = '<option value="">-- Choose a player --</option>';
        players.forEach(player => {
          const option = document.createElement("option");
          option.value = player.name;
          option.textContent = player.name;
          playerSelect.appendChild(option);
        });
        
        // Update progress table
        updateProgressTable(players);
        
      } catch (err) {
        console.error("Error loading players:", err);
        playerSelect.innerHTML = '<option value="">-- Error loading players --</option>';
      } finally {
        hideLoading();
      }
    }

    function updateProgressTable(players) {
      if (players.length === 0) {
        progressTable.style.display = "none";
        return;
      }
      
      progressTable.style.display = "block";
      progressList.innerHTML = "";
      
      // Sort players by count (descending)
      players.sort((a, b) => b.count - a.count);
      
      players.forEach(player => {
        const row = document.createElement("div");
        row.className = "progress-row";
        row.innerHTML = `
          <span class="progress-name">${player.name}</span>
          <span class="progress-count">${player.count}/${squares.length}</span>
        `;
        progressList.appendChild(row);
      });
    }

    async function loadPhotos(player) {
      try {
        showLoading();
        const res = await fetch(`${workerURL}player?name=${encodeURIComponent(player)}`);
        const data = await res.json();
        squares.forEach((square, index) => {
          const resultDiv = document.getElementById(`result${index}`);
          const uploadSection = document.getElementById(`upload${index}`);
          const url = data[square];
          if (url) {
            resultDiv.innerHTML = `
              <img src="${url}" alt="${square}" onclick="window.open('${url}', '_blank')" style="cursor: pointer; opacity:0; transition: opacity 0.3s ease;" onload="this.style.opacity='1'" />
            `;
            // Hide the upload section since photo is already loaded
            if (uploadSection) {
              uploadSection.classList.add('hidden');
            }
          } else {
            resultDiv.innerHTML = "";
            // Show the upload section if no photo is loaded
            if (uploadSection) {
              uploadSection.classList.remove('hidden');
            }
          }
        });
        updateProgress();
        // Refresh progress table after loading photos
        loadPlayers();
      } catch (err) {
        console.error("Error loading photos:", err);
        // Clear all photo displays on error
        squares.forEach((square, index) => {
          const resultDiv = document.getElementById(`result${index}`);
          resultDiv.innerHTML = "";
        });
      } finally {
        hideLoading();
      }
    }

    async function updateProgress() {
      const filled = [...document.querySelectorAll("[id^='result'] img")].length;
      progressDisplay.textContent = `${currentPlayer} has completed ${filled} of ${squares.length} squares.`;
    }

    async function updateLeaderboard() {
      const res = await fetch(`${workerURL}leader`);
      const data = await res.json();
      leaderDisplay.textContent = data.name
        ? `üèÜ Leader: ${data.name} (${data.count}/${squares.length})`
        : "";
    }

    // Handle new player input - automatically set as current player
    newPlayerInput.addEventListener("input", () => {
      const newName = newPlayerInput.value.trim();
      if (newName && newName !== currentPlayer) {
        currentPlayer = newName;
        playerSelect.value = "";
        createGrid();
        loadPhotos(currentPlayer);
      }
    });

    playerSelect.addEventListener("change", () => {
      if (playerSelect.value) {
        currentPlayer = playerSelect.value;
        newPlayerInput.value = "";
        createGrid();
        loadPhotos(currentPlayer);
      }
    });

    // Test worker connection
    async function testWorkerConnection() {
      try {
        console.log("Testing worker connection...");
        const res = await fetch(workerURL);
        const text = await res.text();
        console.log("Worker response:", text);
        return true;
      } catch (err) {
        console.error("Worker connection failed:", err);
        return false;
      }
    }

    // Initialize app
    createGrid();
    testWorkerConnection().then(connected => {
      if (connected) {
        loadPlayers();
        updateLeaderboard();
      } else {
        console.error("Cannot connect to worker, skipping player load");
      }
    });
  </script>
</body>
</html>
