<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kamp Bingo Photo Upload</title>
<style>
  body { font-family: Arial, sans-serif; background: #fafafa; margin: 0; padding: 20px; }
  h1 { text-align: center; }
  #upload-form, #leaderboard { max-width: 600px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  label { display: block; margin-bottom: 10px; }
  input[type="text"], input[type="file"] { width: 100%; margin-bottom: 10px; padding: 8px; }
  button { padding: 10px 20px; border: none; border-radius: 5px; background: #0078f2; color: white; cursor: pointer; }
  button:hover { background: #005fcc; }
  #status { text-align: center; margin-top: 10px; font-weight: bold; }
  #leader { text-align: center; font-size: 1.2em; color: #333; margin-top: 10px; }
  #gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
  #gallery img { width: 100%; border-radius: 8px; object-fit: cover; }
</style>
</head>
<body>

<h1>Kamp Bingo Photos</h1>

<div id="upload-form">
  <label for="player">Your Name:</label>
  <input type="text" id="player" placeholder="Enter your name" required />
  <label for="photo">Upload Photo:</label>
  <input type="file" id="photo" accept="image/*" required />
  <button id="uploadBtn">Upload</button>
  <div id="status"></div>
</div>

<div id="leaderboard">
  <div id="leader">Leader: Loading...</div>
  <div id="gallery"></div>
</div>

<script>
const workerURL = "https://rapid-hill-7b92.reinier-olivier.workers.dev/";
let uploadCounts = {};

async function loadGallery() {
  const res = await fetch(workerURL + "?list=true");
  const data = await res.json();
  const gallery = document.getElementById("gallery");
  gallery.innerHTML = "";

  uploadCounts = {};

  data.objects?.forEach(obj => {
    const nameParts = obj.key.split("/");
    const filename = nameParts[nameParts.length - 1];
    const player = filename.split("_")[0] || "unknown";
    uploadCounts[player] = (uploadCounts[player] || 0) + 1;

    const img = document.createElement("img");
    img.src = `${workerURL}?file=${encodeURIComponent(obj.key)}`;
    img.alt = filename;
    gallery.appendChild(img);
  });

  updateLeader();
}

function updateLeader() {
  let leader = "No uploads yet";
  let max = 0;
  for (const player in uploadCounts) {
    if (uploadCounts[player] > max) {
      max = uploadCounts[player];
      leader = `${player} (${max} photos)`;
    }
  }
  document.getElementById("leader").textContent = "Leader: " + leader;
}

document.getElementById("uploadBtn").addEventListener("click", async () => {
  const player = document.getElementById("player").value.trim();
  const fileInput = document.getElementById("photo");
  const file = fileInput.files[0];
  const status = document.getElementById("status");

  if (!player || !file) {
    status.textContent = "Please enter your name and select a file.";
    return;
  }

  status.textContent = "Uploading...";
  const formData = new FormData();
  const newName = `${player}_${file.name}`;
  formData.append("file", file, newName);

  try {
    const res = await fetch(workerURL, { method: "POST", body: formData });
    if (res.ok) {
      status.textContent = "Upload successful!";
      await loadGallery();
    } else {
      status.textContent = "Upload failed.";
    }
  } catch (err) {
    console.error(err);
    status.textContent = "Error uploading file.";
  }
});

loadGallery();
</script>
</body>
</html>
