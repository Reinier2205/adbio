<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KampBingo ‚Äì Birthday Camp Photo Bingo</title>
  <style>
    :root {
      --green: #2ecc71;
      --red: #e74c3c;
      --black: #1e1e1e;
      --gray: #f9f9f9;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--black);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: white;
      font-size: 2.2rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-weight: bold;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    select, input[type="text"], button {
      padding: 12px 16px;
      font-size: 1rem;
      margin: 8px;
      border-radius: 10px;
      border: 2px solid var(--green);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #27ae60;
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
      transform: translateY(-1px);
    }

    button {
      background-color: var(--black);
      color: white;
      cursor: pointer;
    }

    .leaderboard {
      text-align: center;
      margin-top: 10px;
      font-size: 1rem;
      color: var(--red);
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      backdrop-filter: blur(10px);
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid rgba(46, 204, 113, 0.3);
      border-top: 3px solid var(--green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-table {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }

    .main-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    @media (min-width: 769px) {
      .main-container {
        display: grid;
        grid-template-columns: 1fr 300px;
        grid-template-rows: auto auto;
        gap: 20px;
      }
      
      .progress-table {
        grid-column: 2;
        grid-row: 1 / -1;
        position: sticky;
        top: 20px;
        height: fit-content;
      }
      
      .controls {
        grid-column: 1;
        grid-row: 1;
      }
      
      .grid {
        grid-column: 1;
        grid-row: 2;
      }
    }

    @media (max-width: 768px) {
      .progress-table {
        position: relative;
        top: auto;
        right: auto;
        margin: 0 auto 20px auto;
        max-width: 100%;
      }
    }

    .progress-table h3 {
      margin: 0 0 10px 0;
      color: var(--green);
      font-size: 1rem;
    }

    .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid var(--gray);
    }

    .progress-row:last-child {
      border-bottom: none;
    }

    .progress-name {
      font-weight: bold;
      color: var(--black);
    }

    .progress-count {
      background: var(--green);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-left: 6px solid var(--green);
      backdrop-filter: blur(10px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .card p {
      margin-bottom: 10px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    input[type="file"] {
      margin-top: 5px;
      font-size: 0.9rem;
    }

    img {
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      margin-top: 10px;
      border-radius: 8px;
      border: 2px solid var(--green);
    }
  </style>
</head>
<body>
  <h1>KampBingo ‚Äì Birthday Camp Photo Bingo</h1>

  <div class="main-container">
    <div class="progress-table" id="progressTable" style="display: none;">
      <h3>üèÜ Progress</h3>
      <div id="progressList"></div>
    </div>

    <div class="controls">
      <select id="playerSelect">
        <option value="">-- Choose a player --</option>
      </select>
      <br>
      <input type="text" id="newPlayerInput" placeholder="Or enter a new name" />
      <div id="progressDisplay"></div>
      <div class="leaderboard" id="leaderDisplay"></div>
    </div>

    <div class="grid" id="bingoGrid"></div>
  </div>

  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner"></div>
    <span>Loading...</span>
  </div>

  <script>
    const squares = [
      "An old photo with Anneke",
      "A photo from a past birthday or braai",
      "The oldest selfie you have together",
      "Anneke walking barefoot (bonus: dirty feet)",
      "Anneke drinking beer (bonus: a cheers moment)",
      "Someone borrowing something from Anneke",
      "Oliver playing ball with someone",
      "The baby with a new 'aunt' or 'uncle'",
      "Everyone gathered around the fire",
      "Anneke reading a book in peace",
      "Morning coffee in a mug that‚Äôs not yours",
      "Oliver 'helping' with something (e.g., pouring tea, fixing, or cooking)",
      "A photo of the sunset or campfire glow",
      "Someone with muddy or sandy feet",
      "Anneke‚Äôs laugh caught in a candid photo",
      "A camp game or activity moment",
      "A creative photo of beer or tea (bonus: both)",
      "Oliver on his bike",
      "A group photo of everyone",
      "Someone looking for their lost item (e.g., phone, shoe, drink)",
      "A photo showing borrowed camping gear",
      "Oliver dunking something in tea",
      "Anneke relaxing with a book and drink",
      "The baby smiling",
      "Everyone waving goodnight at the fire"
    ];

    const workerURL = "https://rapid-hill-7b92.reinier-olivier.workers.dev/";
    const grid = document.getElementById("bingoGrid");
    const playerSelect = document.getElementById("playerSelect");
    const newPlayerInput = document.getElementById("newPlayerInput");
    const progressDisplay = document.getElementById("progressDisplay");
    const leaderDisplay = document.getElementById("leaderDisplay");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const progressTable = document.getElementById("progressTable");
    const progressList = document.getElementById("progressList");

    let currentPlayer = "";

    function showLoading() {
      console.log("Showing loading spinner");
      loadingSpinner.style.display = "block";
    }

    function hideLoading() {
      console.log("Hiding loading spinner");
      loadingSpinner.style.display = "none";
    }

    function createGrid() {
      grid.innerHTML = "";
      squares.forEach((square, index) => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <p>${square}</p>
          <input type="file" id="file${index}" />
          <div id="result${index}"></div>
        `;
        grid.appendChild(div);

        const fileInput = div.querySelector(`#file${index}`);
        const resultDiv = div.querySelector(`#result${index}`);

        fileInput.addEventListener("change", async (e) => {
          if (!currentPlayer) return alert("Select or enter your name first.");
          const file = e.target.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);
          formData.append("player", currentPlayer);
          formData.append("square", square);

          resultDiv.textContent = "Uploading...";
          showLoading();

          try {
            const res = await fetch(workerURL, { method: "POST", body: formData });
            const data = await res.json();
            if (data.url) {
              resultDiv.innerHTML = `<a href="${data.url}" target="_blank">View Photo</a><br><img src="${data.url}" />`;
              updateProgress();
              updateLeaderboard();
              // Refresh player list to include new players and update progress table
              loadPlayers();
            } else {
              resultDiv.textContent = "Upload failed.";
            }
          } catch (err) {
            resultDiv.textContent = "Error uploading photo.";
          } finally {
            hideLoading();
          }
        });
      });
    }

    async function loadPlayers() {
      try {
        showLoading();
        const res = await fetch(`${workerURL}players`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const players = await res.json();
        
        // Clear existing options except the first one
        playerSelect.innerHTML = '<option value="">-- Choose a player --</option>';
        players.forEach(player => {
          const option = document.createElement("option");
          option.value = player.name;
          option.textContent = player.name;
          playerSelect.appendChild(option);
        });
        
        // Update progress table
        updateProgressTable(players);
        
      } catch (err) {
        console.error("Error loading players:", err);
        playerSelect.innerHTML = '<option value="">-- Error loading players --</option>';
      } finally {
        hideLoading();
      }
    }

    function updateProgressTable(players) {
      if (players.length === 0) {
        progressTable.style.display = "none";
        return;
      }
      
      progressTable.style.display = "block";
      progressList.innerHTML = "";
      
      // Sort players by count (descending)
      players.sort((a, b) => b.count - a.count);
      
      players.forEach(player => {
        const row = document.createElement("div");
        row.className = "progress-row";
        row.innerHTML = `
          <span class="progress-name">${player.name}</span>
          <span class="progress-count">${player.count}/${squares.length}</span>
        `;
        progressList.appendChild(row);
      });
    }

    async function loadPhotos(player) {
      try {
        showLoading();
        const res = await fetch(`${workerURL}player?name=${encodeURIComponent(player)}`);
        const data = await res.json();
        squares.forEach((square, index) => {
          const resultDiv = document.getElementById(`result${index}`);
          const url = data[square];
          if (url) {
            resultDiv.innerHTML = `<a href="${url}" target="_blank">View Photo</a><br><img src="${url}" />`;
          } else {
            resultDiv.innerHTML = "";
          }
        });
        updateProgress();
        // Refresh progress table after loading photos
        loadPlayers();
      } catch (err) {
        console.error("Error loading photos:", err);
        // Clear all photo displays on error
        squares.forEach((square, index) => {
          const resultDiv = document.getElementById(`result${index}`);
          resultDiv.innerHTML = "";
        });
      } finally {
        hideLoading();
      }
    }

    async function updateProgress() {
      const filled = [...document.querySelectorAll("[id^='result'] img")].length;
      progressDisplay.textContent = `${currentPlayer} has completed ${filled} of ${squares.length} squares.`;
    }

    async function updateLeaderboard() {
      const res = await fetch(`${workerURL}leader`);
      const data = await res.json();
      leaderDisplay.textContent = data.name
        ? `üèÜ Leader: ${data.name} (${data.count}/${squares.length})`
        : "";
    }

    // Handle new player input - automatically set as current player
    newPlayerInput.addEventListener("input", () => {
      const newName = newPlayerInput.value.trim();
      if (newName && newName !== currentPlayer) {
        currentPlayer = newName;
        playerSelect.value = "";
        createGrid();
        loadPhotos(currentPlayer);
      }
    });

    playerSelect.addEventListener("change", () => {
      if (playerSelect.value) {
        currentPlayer = playerSelect.value;
        newPlayerInput.value = "";
        createGrid();
        loadPhotos(currentPlayer);
      }
    });

    // Test worker connection
    async function testWorkerConnection() {
      try {
        console.log("Testing worker connection...");
        const res = await fetch(workerURL);
        const text = await res.text();
        console.log("Worker response:", text);
        return true;
      } catch (err) {
        console.error("Worker connection failed:", err);
        return false;
      }
    }

    // Initialize app
    createGrid();
    testWorkerConnection().then(connected => {
      if (connected) {
        loadPlayers();
        updateLeaderboard();
      } else {
        console.error("Cannot connect to worker, skipping player load");
      }
    });
  </script>
</body>
</html>
