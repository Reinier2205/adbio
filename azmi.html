<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sunrise & Live Sun Compass</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;line-height:1.4}
    label,input,button{display:block;margin:6px 0}
    .row{display:flex;gap:8px;align-items:center}
    #compass{width:300px;height:300px;border-radius:50%;border:2px solid #222;position:relative;margin-top:12px;overflow:hidden}
    #dial{width:100%;height:100%;position:absolute;inset:0;transition:transform .2s linear}
    .needle{position:absolute;left:50%;top:50%;width:3px;height:40%;transform-origin:50% 100%}
    #sunriseNeedle{background:#c00}
    #liveNeedle{background:gold}
    #north{position:absolute;left:50%;top:6px;transform:translateX(-50%);font-weight:600}
    .info{margin-top:10px;padding:10px;border:1px solid #ddd;background:#fafafa}
  </style>
</head>
<body>
  <h2>Sunrise & Live Sun Compass</h2>

  <label>Latitude
    <input id="lat" type="number" step="0.00001" value="-33.9258" />
  </label>
  <label>Longitude
    <input id="lon" type="number" step="0.00001" value="18.4232" />
  </label>
  <label>Date
    <input id="date" type="date" value="" />
  </label>

  <div class="row">
    <button id="calc">Calculate sunrise</button>
    <button id="now">Use my GPS</button>
  </div>

  <div class="info" id="result">Azimuth: —°<br>Sunrise: —</div>
  <div class="info" id="liveResult">Live sun azimuth: —°<br>Altitude: —°</div>

  <div id="compass">
    <div id="dial">
      <svg viewBox="0 0 100 100" width="100%" height="100%">
        <g transform="translate(50,50)">
          <circle r="48" fill="none" stroke="#333" stroke-width="1"/>
          <g id="ticks"></g>
        </g>
      </svg>
    </div>
    <div id="sunriseNeedle" class="needle"></div>
    <div id="liveNeedle" class="needle"></div>
    <div id="north">N</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
  <script>
    // Add ticks to compass
    (function(){
      const g=document.getElementById('ticks');
      for(let i=0;i<360;i+=10){
        const len=(i%90===0)?8:(i%30===0?6:3);
        const r1=42, r2=42-len;
        const rad=i*Math.PI/180;
        const x1=Math.cos(rad)*r1, y1=Math.sin(rad)*r1;
        const x2=Math.cos(rad)*r2, y2=Math.sin(rad)*r2;
        const line=document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1",x1);line.setAttribute("y1",y1);
        line.setAttribute("x2",x2);line.setAttribute("y2",y2);
        line.setAttribute("stroke","#000");line.setAttribute("stroke-width","0.8");
        g.appendChild(line);
        if(i%90===0){
          const text=document.createElementNS("http://www.w3.org/2000/svg","text");
          text.setAttribute("x",Math.cos(rad)*35);
          text.setAttribute("y",Math.sin(rad)*35+3);
          text.setAttribute("text-anchor","middle");
          text.setAttribute("font-size","6");
          text.textContent=i===0?'E':i===90?'S':i===180?'W':'N';
          g.appendChild(text);
        }
      }
    })();

    function toLocalString(d){
      return new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(d);
    }
    function sunAzToBearing(azRad){
      return ((azRad*180/Math.PI)+180+360)%360;
    }

    let sunriseBearing=null;
    let lat=parseFloat(document.getElementById('lat').value);
    let lon=parseFloat(document.getElementById('lon').value);

    // Calculate sunrise
    document.getElementById('calc').addEventListener('click',()=>{
      lat=parseFloat(document.getElementById('lat').value);
      lon=parseFloat(document.getElementById('lon').value);
      const dateInput=document.getElementById('date').value;
      const date=dateInput?new Date(dateInput):new Date();
      const times=SunCalc.getTimes(date,lat,lon);
      const sunrise=times.sunrise;
      if(!sunrise){alert("No sunrise (polar day/night)");return;}
      const pos=SunCalc.getPosition(sunrise,lat,lon);
      sunriseBearing=sunAzToBearing(pos.azimuth);
      document.getElementById('result').innerHTML=
        `Azimuth: <b>${sunriseBearing.toFixed(1)}°</b><br>Sunrise: <b>${toLocalString(sunrise)}</b>`;
      document.getElementById('sunriseNeedle').style.transform=
        `translateX(-50%) rotate(${sunriseBearing}deg)`;
    });

    // Use GPS
    document.getElementById('now').addEventListener('click',()=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        lat=pos.coords.latitude;
        lon=pos.coords.longitude;
        document.getElementById('lat').value=lat.toFixed(5);
        document.getElementById('lon').value=lon.toFixed(5);
      });
    });

    // Device orientation for compass dial
    window.addEventListener('deviceorientation',e=>{
      if(e.absolute===false && typeof e.webkitCompassHeading==="undefined") return;
      let heading;
      if(e.webkitCompassHeading!==undefined){ // iOS
        heading=e.webkitCompassHeading;
      }else{ // Android
        heading=360-e.alpha;
      }
      document.getElementById('dial').style.transform=`rotate(${-heading}deg)`;
    });

    // Live sun updater
    setInterval(()=>{
      if(isNaN(lat)||isNaN(lon)) return;
      const now=new Date();
      const pos=SunCalc.getPosition(now,lat,lon);
      const bearing=sunAzToBearing(pos.azimuth);
      const alt=pos.altitude*180/Math.PI;
      document.getElementById('liveNeedle').style.transform=
        `translateX(-50%) rotate(${bearing}deg)`;
      document.getElementById('liveResult').innerHTML=
        `Live sun azimuth: <b>${bearing.toFixed(1)}°</b><br>Altitude: <b>${alt.toFixed(1)}°</b>`;
    },1000);

    // Default date = today
    (function(){
      const d=new Date();
      const yyyy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
      document.getElementById('date').value=`${yyyy}-${mm}-${dd}`;
    })();
  </script>
</body>
</html>