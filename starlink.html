<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Starlink Pass Predictor (Auto TLE)</title>
<script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
</head>
<body>
<h2>Starlink Pass Predictor (Pretoria)</h2>

<p>Select date and time for prediction:</p>
<input type="datetime-local" id="datetime" value="">
<button onclick="predictPasses()">Get Starlink Passes</button>

<ul id="passes"></ul>

<script>
async function predictPasses() {
  const passesList = document.getElementById("passes");
  passesList.innerHTML = "Loading...";

  const lat = -25.7479;
  const lon = 28.2293;
  const height = 1.32; // km

  const inputDate = document.getElementById("datetime").value;
  let startDate = inputDate ? new Date(inputDate) : new Date();
  let endDate = new Date(startDate.getTime() + 48*60*60*1000); // next 48 hours

  try {
    // Download latest Starlink TLEs
    const tleUrl = "https://celestrak.com/NORAD/elements/starlink.txt";
    const res = await fetch(tleUrl);
    const tleText = await res.text();
    const tleLines = tleText.trim().split("\n");

    // Parse TLEs into satellites
    let satellites = [];
    for(let i=0; i<tleLines.length; i+=3){
      const name = tleLines[i].trim();
      const line1 = tleLines[i+1];
      const line2 = tleLines[i+2];
      satellites.push({name, satrec: satellite.twoline2satrec(line1, line2)});
    }

    passesList.innerHTML = "";

    for(const sat of satellites){
      let visible = false;
      let passStart = null;

      for(let t = new Date(startDate); t < endDate; t.setMinutes(t.getMinutes()+1)){
        const gmst = satellite.gstime(t);
        const eciPos = satellite.propagate(sat.satrec, t);
        if(!eciPos.position) continue;

        const lookAngles = satellite.ecfToLookAngles(
          {latitude: lat, longitude: lon, height: height},
          satellite.eciToEcf(eciPos.position, gmst)
        );

        const elevation = lookAngles.elevation * 180 / Math.PI;

        if(elevation > 10 && !visible){
          visible = true;
          passStart = new Date(t);
        } else if(elevation <= 10 && visible){
          visible = false;
          const li = document.createElement("li");
          li.textContent = `${sat.name}: Start: ${passStart.toLocaleString()} â†’ End: ${t.toLocaleString()}`;
          passesList.appendChild(li);
        }
      }
    }

    if(passesList.innerHTML === ""){
      passesList.innerHTML = "<li>No visible passes in the next 48 hours.</li>";
    }

  } catch(err){
    passesList.innerHTML = "<li>Error fetching or processing TLE data.</li>";
    console.error(err);
  }
}
</script>
</body>
</html>