<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Starlink Pass Predictor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>Starlink Passes (next 24 hours)</h1>
  <p>Location: <span id="location">Detecting...</span></p>
  <table>
    <thead>
      <tr><th>Satellite</th><th>Start</th><th>End</th><th>Max Elevation</th></tr>
    </thead>
    <tbody id="passes"></tbody>
  </table>

  <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
  <script>
    const workerURL = "https://starlink-tle.reinier-olivier.workers.dev/";

    async function fetchTLEs() {
      const res = await fetch(workerURL);
      return (await res.text()).trim().split("\n");
    }

    function parseTLEs(lines) {
      let sats = [];
      for (let i = 0; i < lines.length; i += 3) {
        if (lines[i+1] && lines[i+2]) {
          sats.push({
            name: lines[i].trim(),
            tle1: lines[i+1].trim(),
            tle2: lines[i+2].trim()
          });
        }
      }
      return sats;
    }

    function getPassesForSatellite(satrec, observer, startTime, endTime) {
      const stepMinutes = 2; // time resolution
      let passes = [];
      let pass = null;

      for (let time = new Date(startTime); time <= endTime; time.setMinutes(time.getMinutes() + stepMinutes)) {
        const gmst = satellite.gstime(new Date(time));
        const eci = satellite.propagate(satrec, time);
        if (!eci.position) continue;
        const geo = satellite.eciToGeodetic(eci.position, gmst);
        const lookAngles = satellite.ecfToLookAngles(observer, satellite.eciToEcf(eci.position, gmst));
        
        if (lookAngles.elevation > 0) {
          if (!pass) {
            pass = { start: new Date(time), maxEl: lookAngles.elevation, end: null };
          } else {
            if (lookAngles.elevation > pass.maxEl) pass.maxEl = lookAngles.elevation;
          }
        } else if (pass) {
          pass.end = new Date(time);
          passes.push(pass);
          pass = null;
        }
      }
      return passes;
    }

    async function main() {
      // detect location
      let lat = -25.7479, lon = 28.2293, height = 0.1; // Pretoria default
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          lat = pos.coords.latitude;
          lon = pos.coords.longitude;
          height = pos.coords.altitude || 0.1;
          document.getElementById("location").textContent = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
        });
      }

      const lines = await fetchTLEs();
      const sats = parseTLEs(lines).slice(0, 20); // limit 20 sats
      const observer = { longitude: satellite.degreesToRadians(lon), latitude: satellite.degreesToRadians(lat), height };

      const startTime = new Date();
      const endTime = new Date(Date.now() + 24 * 3600 * 1000);

      const tbody = document.getElementById("passes");

      for (let sat of sats) {
        const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
        const passes = getPassesForSatellite(satrec, observer, startTime, endTime);

        for (let p of passes) {
          let row = document.createElement("tr");
          row.innerHTML = `<td>${sat.name}</td>
                           <td>${p.start.toLocaleString()}</td>
                           <td>${p.end.toLocaleString()}</td>
                           <td>${(p.maxEl * 180/Math.PI).toFixed(1)}Â°</td>`;
          tbody.appendChild(row);
        }
      }
    }

    main();
  </script>
</body>
</html>
