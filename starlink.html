<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visible Starlink Passes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    #error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Visible Starlink Passes (next 12 hours)</h1>
  <p>Location: <span id="location">Detecting...</span></p>
  <p id="window"></p>
  <p id="error"></p>
  <table>
    <thead>
      <tr>
        <th>Satellite</th><th>Start</th><th>End</th>
        <th>Start Dir</th><th>End Dir</th><th>Max Elevation</th>
      </tr>
    </thead>
    <tbody id="passes"></tbody>
  </table>

  <script src="https://unpkg.com/satellite.js/dist/satellite.min.js"></script>
  <script src="https://unpkg.com/suncalc/suncalc.js"></script>
  <script>
    const workerURL = "https://starlink-tle.reinier-olivier.workers.dev/";

    async function fetchTLEs() {
      const res = await fetch(workerURL);
      if (!res.ok) throw new Error("Failed to fetch TLE data");
      return (await res.text()).trim().split("\n");
    }

    function parseTLEs(lines) {
      let sats = [];
      for (let i = 0; i < lines.length; i += 3) {
        if (lines[i+1] && lines[i+2]) {
          sats.push({
            name: lines[i].trim(),
            tle1: lines[i+1].trim(),
            tle2: lines[i+2].trim()
          });
        }
      }
      return sats;
    }

    function azToCompass(rad) {
      const deg = (rad * 180 / Math.PI + 360) % 360;
      const dirs = ["N","NE","E","SE","S","SW","W","NW"];
      return dirs[Math.round(deg / 45) % 8];
    }

    function getPassesForSatellite(satrec, observer, startTime, endTime) {
      const stepMinutes = 1;
      let passes = [], pass = null;

      for (let time = new Date(startTime); time <= endTime; time.setMinutes(time.getMinutes() + stepMinutes)) {
        const gmst = satellite.gstime(time);
        const eci = satellite.propagate(satrec, time);
        if (!eci.position) continue;
        const ecf = satellite.eciToEcf(eci.position, gmst);
        const look = satellite.ecfToLookAngles(observer, ecf);

        if (look.elevation > 0) {
          if (!pass) {
            pass = { start: new Date(time), maxEl: look.elevation, end: null, startAz: look.azimuth, endAz: null };
          } else if (look.elevation > pass.maxEl) {
            pass.maxEl = look.elevation;
          }
        } else if (pass) {
          pass.end = new Date(time);
          pass.endAz = look.azimuth;
          passes.push(pass);
          pass = null;
        }
      }
      return passes;
    }

    async function main(lat, lon, height) {
      document.getElementById("location").textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;

      const now = new Date();
      const twelveHours = new Date(Date.now() + 12*3600*1000);

      const sunTimes = SunCalc.getTimes(now, lat, lon);
      const sunset = sunTimes.sunset;
      const sunrise = SunCalc.getTimes(new Date(now.getTime()+86400000), lat, lon).sunrise;
      
      const windowStart = sunset < now ? now : sunset;
      const windowEnd = sunrise < twelveHours ? sunrise : twelveHours;

      document.getElementById("window").textContent = 
        `Showing passes between ${windowStart.toLocaleTimeString()} and ${windowEnd.toLocaleTimeString()}`;

      const lines = await fetchTLEs();
      const sats = parseTLEs(lines).slice(0, 15); // limit 15 for speed
      const observer = {
        longitude: satellite.degreesToRadians(lon),
        latitude: satellite.degreesToRadians(lat),
        height
      };

      const tbody = document.getElementById("passes");
      for (let sat of sats) {
        const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
        const passes = getPassesForSatellite(satrec, observer, windowStart, windowEnd);

        for (let p of passes) {
          let row = document.createElement("tr");
          row.innerHTML = `
            <td>${sat.name}</td>
            <td>${p.start.toLocaleTimeString()}</td>
            <td>${p.end.toLocaleTimeString()}</td>
            <td>${azToCompass(p.startAz)}</td>
            <td>${azToCompass(p.endAz)}</td>
            <td>${(p.maxEl*180/Math.PI).toFixed(0)}Â°</td>`;
          tbody.appendChild(row);
        }
      }
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const height = pos.coords.altitude || 0.1;
          main(lat, lon, height);
        },
        err => {
          document.getElementById("error").textContent = "Error: Location required. " + err.message;
          document.getElementById("location").textContent = "Unavailable";
        }
      );
    } else {
      document.getElementById("error").textContent = "Error: Geolocation not supported by this device.";
      document.getElementById("location").textContent = "Unavailable";
    }
  </script>
</body>
</html>
