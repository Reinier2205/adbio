<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Celestial Finder | Sun & Moon</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
  <!-- SunCalc library for celestial mechanics -->
  <script src="https://unpkg.com/suncalc/suncalc.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e0e0e0; }
    .felt-green { background-color: #2c0e3a; } /* Deep Space Purple */
    .gold-text { color: #ffb703; } /* Vibrant Gold */
    .btn-primary { background-color: #ffb703; color: #121212; transition: transform .2s ease, box-shadow .2s ease; font-weight: 800; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,183,3,.4); }
    .panel { background:#1f1f1f; border:2px solid rgba(255,183,3,0.5); border-radius: 16px; box-shadow: 0 5px 25px rgba(0,0,0,0.6); }
    #compassCanvas { background: rgba(255,255,255,0.05); border-radius: 9999px; border:2px solid rgba(255,255,255,0.1); }
    /* Hide number input arrows */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] { -moz-appearance: textfield; }
    /* Custom style for the fixed compass indicator */
    #device-indicator {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 15px solid rgba(255, 255, 255, 0.4); /* Light arrow */
    }
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
    }
  </style>
</head>
<body class="antialiased min-h-screen">
  <header class="felt-green p-4 sticky top-0 z-50 shadow-xl">
    <nav class="container mx-auto flex justify-between items-center max-w-7xl">
      <a href="#" class="text-2xl font-bold gold-text flex items-center gap-2">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.106a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.06l1.59-1.591ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H21a.75.75 0 0 1 .75.75ZM18.894 18.894a.75.75 0 0 0 1.06-1.06l-1.59-1.59a.75.75 0 1 0-1.06 1.06l1.59 1.59ZM12 17.25a.75.75 0 0 1-.75.75H9a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM5.659 15.659a.75.75 0 0 0-1.06 1.06l1.59 1.59a.75.75 0 0 0 1.06-1.06l-1.59-1.59ZM3 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12ZM4.566 7.166a.75.75 0 0 0 1.06-1.06l-1.59-1.59a.75.75 0 0 0-1.06 1.06l1.59 1.59Z" />
        </svg>
        Celestial Finder
      </a>
      <div class="hidden sm:flex items-center gap-3">
        <a href="#inputs" class="btn-primary font-bold py-2 px-4 rounded-full text-sm hover:ring-2 ring-offset-2 ring-offset-[#121212] ring-[#ffb703]">Plan Trip</a>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 py-10 max-w-7xl">
    <section class="text-center py-8">
      <h1 class="text-3xl md:text-4xl font-extrabold gold-text mb-2">Solar, Lunar, and ISS Dynamics</h1>
      <p class="text-lg md:text-xl max-w-3xl mx-auto text-gray-400">Track celestial events based on your location and heading.</p>
    </section>

    <section id="inputs" class="max-w-4xl mx-auto panel p-6 md:p-8">
      
      <!-- Legend -->
      <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mb-6 text-xs text-gray-400">
        <div class="flex items-center gap-2">
          <div class="w-4 h-1.5 bg-red-500 rounded-full"></div>
          <span>Sunrise Azimuth</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-1.5 bg-blue-500 rounded-full"></div>
          <span>Sunset Azimuth</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full bg-yellow-400 border border-yellow-600"></span>
          <span>Live Sun</span>
        </div>
      </div>

      <!-- Main Content Container (Single Column for Mobile optimization) -->
      <div class="space-y-8"> 
        
        <!-- Input Fields -->
        <div class="space-y-4">
          <!-- Heading: Location & Date Input -->
          <h2 class="text-2xl font-extrabold text-gray-200">1. Set Location and Date</h2>
          
          <!-- Date Input -->
          <label class="block">
            <span class="block text-sm font-medium text-gray-300 mb-1">Date</span>
            <input id="date" type="date" class="w-full rounded-lg bg-gray-800 border border-gray-700 p-3 text-gray-100 placeholder-gray-500 shadow-inner">
          </label>
          
          <!-- Lat/Lon Input -->
          <div class="flex gap-4">
            <label class="flex-1 block">
              <span class="block text-sm font-medium text-gray-300 mb-1">Latitude (S = -)</span>
              <input id="lat" type="number" step="any" class="w-full rounded-lg bg-gray-800 border border-gray-700 p-3 text-gray-100 placeholder-gray-500 shadow-inner" placeholder="Enter Latitude...">
            </label>
            <label class="flex-1 block">
              <span class="block text-sm font-medium text-gray-300 mb-1">Longitude (W = -)</span>
              <input id="lon" type="number" step="any" class="w-full rounded-lg bg-gray-800 border border-gray-700 p-3 text-gray-100 placeholder-gray-500 shadow-inner" placeholder="Enter Longitude...">
            </label>
          </div>
        </div>
        
        <!-- Action Button -->
        <div class="flex flex-wrap justify-center sm:justify-start gap-3 mt-6">
          <button id="btn-calc" class="btn-primary py-3 px-6 rounded-xl flex items-center gap-2 text-sm w-full sm:w-auto">
            Recalculate Data
          </button>
        </div>

        <!-- RELOCATED: Compass and Live Data -->
        <div class="flex flex-col items-center justify-center panel p-4 bg-gray-900/40 border-gray-700">
            <h2 class="text-2xl font-extrabold gold-text mb-4 text-center">2. Live Compass Tracking</h2>
            <div class="w-full max-w-xs aspect-square p-2 relative">
              <canvas id="compassCanvas" width="300" height="300" class="w-full h-full"></canvas>
              <!-- Fixed device North indicator -->
              <div id="device-indicator" style="top: 15px;"></div>
            </div>
            <!-- Live Data Panel -->
            <div id="live-data" class="mt-4 w-full max-w-xs text-center p-3 bg-gray-800 rounded-xl border border-gray-700 shadow-md">
              <p class="text-sm text-gray-400 mb-1">Device Heading</p>
              <div class="text-3xl font-bold gold-text" id="current-heading">---Â°</div>
              <div class="text-sm text-gray-400" id="live-sun-alt">---</div>
            </div>
        </div>
        <!-- END RELOCATED BLOCK -->

        <!-- Results Panel -->
        <div id="results" role="status" aria-live="polite">
          <div class="bg-gray-900/40 border border-gray-800 rounded-xl p-4 text-center text-gray-500">
              Awaiting location and time data. Enter coordinates or click 'Grant Access' in the prompt.
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- *** MODALS *** -->

  <!-- Permission Request Modal -->
  <div id="permission-modal" class="fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
    <div class="panel bg-gray-900 p-8 max-w-sm w-full transform transition-all duration-300 scale-100 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 gold-text mx-auto mb-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m.75-9.75l.348-.285c1.458-.883 3.32-.883 4.778 0l.348.285A1.5 1.5 0 0 1 15 8.25v2.25m-4.5-9.75v6.75m.75-6.75l.348-.285c1.458-.883 3.32-.883 4.778 0l.348.285A1.5 1.5 0 0 1 15 8.25v2.25m-4.5-9.75V15M3.75 8.25v6A2.25 2.25 0 0 0 6 16.5h12A2.25 2.25 0 0 0 20.25 15v-6A2.25 2.25 0 0 0 18 6H6a2.25 2.25 0 0 0-2.25 2.25Z" />
      </svg>
      <h3 class="text-xl font-bold text-gray-200 mb-2">Location and Compass Required</h3>
      <p class="text-sm text-gray-400 mb-6">To accurately calculate celestial events and provide live compass tracking, we need permission for your **current location (GPS)** and **device orientation (Compass)**.</p>
      <button onclick="requestPermissions()" class="btn-primary py-3 px-6 rounded-xl w-full">
        Grant Access & Start
      </button>
      <button onclick="togglePermissionModal(false)" class="text-gray-500 hover:text-gray-300 text-sm mt-3">
        Skip (I will enter coordinates manually)
      </button>
    </div>
  </div>


  <!-- Twilight Info Modal -->
  <div id="twilight-modal" class="hidden fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
    <div class="panel bg-gray-900 p-6 max-w-lg w-full transform transition-all duration-300 scale-100">
      <h3 class="text-2xl font-bold gold-text mb-4 border-b border-gray-700 pb-2">Understanding Twilight</h3>
      <table class="w-full text-left text-sm">
        <thead class="text-xs gold-text uppercase bg-gray-800">
          <tr>
            <th scope="col" class="px-3 py-2">Phase</th>
            <th scope="col" class="px-3 py-2">Description / Traveller Use</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b border-gray-700 hover:bg-gray-800/50">
            <td class="px-3 py-2 font-medium text-gray-200">Civil Twilight</td>
            <td class="px-3 py-2 text-gray-400">Brightest twilight. Enough light for outdoor activities without artificial lighting. **Golden/Blue Hour** is around this time.</td>
          </tr>
          <tr class="border-b border-gray-700 hover:bg-gray-800/50">
            <td class="px-3 py-2 font-medium text-gray-200">Nautical Twilight</td>
            <td class="px-3 py-2 text-gray-400">The horizon is still distinguishable (useful for navigation at sea), but artificial light is required for most activities. Good for **early star visibility**.</td>
          </tr>
          <tr class="hover:bg-gray-800/50">
            <td class="px-3 py-2 font-medium text-gray-200">Astronomical Twilight</td>
            <td class="px-3 py-2 text-gray-400">The sky is essentially dark; the very faint stars are now visible. Used by astronomers to mark the start of **true darkness (for deep sky photography)**.</td>
          </tr>
        </tbody>
      </table>
      <div class="mt-6 text-right">
        <button onclick="toggleTwilightModal(false)" class="bg-indigo-600 text-white py-2 px-5 rounded-lg hover:bg-indigo-700 transition duration-200">Close</button>
      </div>
    </div>
  </div>

  <!-- ISS Info Modal -->
  <div id="iss-modal" class="hidden fixed inset-0 z-[100] modal-backdrop flex items-center justify-center p-4">
    <div class="panel bg-gray-900 p-6 max-w-lg w-full transform transition-all duration-300 scale-100">
      <h3 class="text-2xl font-bold gold-text mb-4 border-b border-gray-700 pb-2">International Space Station (ISS)</h3>
      
      <p class="text-gray-300 mb-4">The ISS is the third brightest object in the sky (after the Sun and Moon) and is easily visible to the naked eye.</p>
      
      <div class="space-y-3 text-gray-400">
        <p><strong>Appearance:</strong> It looks like a bright, white pinpoint of light moving steadily across the sky, much faster than an airplane and without flashing lights.</p>
        <p><strong>Visibility:</strong> It is only visible when it is **reflecting sunlight**. This means the best times are right after **sunset** and right before **sunrise**, when your ground location is dark but the station is high enough to catch the sun's light.</p>
        <p><strong>Coverage:</strong> Due to its orbit, the ISS is visible from about $95\%$ of the Earth's inhabited surface.</p>
        <p class="text-sm text-red-400 pt-2 border-t border-gray-700 mt-4">**Note:** For current, accurate pass predictions, you must use a dedicated online tool (like the one linked in the main results section) as those calculations require complex, real-time data.</p>
      </div>

      <div class="mt-6 text-right">
        <button onclick="toggleIssModal(false)" class="bg-indigo-600 text-white py-2 px-5 rounded-lg hover:bg-indigo-700 transition duration-200">Close</button>
      </div>
    </div>
  </div>

<script>
// Global variables for calculated astronomical data
let sunriseAzimuth = null;
let sunsetAzimuth = null;
let liveAzimuth = null;
let lat_value = null;
let lon_value = null;

// Variables for device compass
let heading = 0;
let lastHeading = 0;

// --- Utility Functions ---

/**
 * Smooths the device heading input to prevent jittering.
 */
function smoothHeading(newH) {
  const k = 0.1;
  lastHeading = lastHeading * (1 - k) + newH * k;
  return lastHeading;
}

/**
 * Determines the moon phase name and emoji.
 */
function getMoonPhaseInfo(moonIllumination) {
  const phase = moonIllumination.phase;
  const fraction = moonIllumination.fraction;
  let name, emoji;

  if (phase < 0.03 || phase > 0.97) {
    name = 'New Moon'; emoji = 'ð';
  } else if (phase < 0.22) {
    name = 'Waxing Crescent'; emoji = 'ð';
  } else if (phase < 0.28) {
    name = 'First Quarter'; emoji = 'ð';
  } else if (phase < 0.47) {
    name = 'Waxing Gibbous'; emoji = 'ð';
  } else if (phase < 0.53) {
    name = 'Full Moon'; emoji = 'ð';
  } else if (phase < 0.72) {
    name = 'Waning Gibbous'; emoji = 'ð';
  } else if (phase < 0.78) {
    name = 'Last Quarter'; emoji = 'ð';
  } else {
    name = 'Waning Crescent'; emoji = 'ð';
  }

  return { name, emoji, fraction: (fraction * 100).toFixed(1) };
}

/**
 * Toggles the visibility of the Permission Request Modal.
 */
function togglePermissionModal(show) {
  const modal = document.getElementById('permission-modal');
  modal.classList.toggle('hidden', !show);
}

/**
 * Toggles the visibility of the Twilight Info Modal.
 */
function toggleTwilightModal(show) {
  const modal = document.getElementById('twilight-modal');
  modal.classList.toggle('hidden', !show);
}

/**
 * Toggles the visibility of the ISS Info Modal.
 */
function toggleIssModal(show) {
  const modal = document.getElementById('iss-modal');
  modal.classList.toggle('hidden', !show);
}

// --- Main Calculation and Display Functions ---

/**
 * Calculates all sun/moon data and updates the UI based on input fields.
 */
function calcCelestialData() {
  const lat = parseFloat(document.getElementById("lat").value);
  const lon = parseFloat(document.getElementById("lon").value);
  
  if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
    document.getElementById("results").innerHTML = `<div class="bg-red-900/40 border border-red-700 rounded-xl p-4 text-center text-red-300">
      Please enter valid Latitude ($\pm 90$) and Longitude ($\pm 180$) to calculate.
    </div>`;
    // Clear global values to prevent drawing the compass with bad data
    lat_value = null;
    lon_value = null;
    sunriseAzimuth = null;
    sunsetAzimuth = null;
    return;
  }
  
  // Store valid coordinates globally
  lat_value = lat;
  lon_value = lon;

  const dateInput = document.getElementById("date").value || new Date().toISOString().split("T")[0];
  const date = new Date(dateInput);

  // 1. Calculate Sun Times and Positions
  const times = SunCalc.getTimes(date, lat, lon);
  
  const sunRises = times.sunrise instanceof Date;
  const sunSets = times.sunset instanceof Date;

  const formatTime = (time, type) => {
    if (time instanceof Date) {
      return time.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
    }
    
    // Logic for high-latitude events (Polar Day/Night, or Continuous Twilight)
    if (!sunRises && !sunSets) {
      // Sun never rises or sets (e.g., Polar Night)
      return '24H Darkness';
    } else if (type === 'twilight' && sunRises && sunSets) {
      // Sun rises and sets, but this specific twilight phase is missed (Continuous Twilight in summer)
      return 'Continuous Twilight';
    } else if (type === 'twilight' && (!sunRises || !sunSets)) {
      // If the sun is only up but doesn't set (e.g., Polar Day), twilight is continuous light
      return '24H Sunlight';
    } else if (type === 'sun_rise_set') {
        // Fallback for primary sunrise/sunset times
        return !sunRises && !sunSets ? '24H Darkness' : '24H Sunlight';
    }

    return 'N/A';
  };

  const sunrisePos = SunCalc.getPosition(times.sunrise, lat, lon);
  // Azimuth is 0-360, but SunCalc returns -180 to 180 (South = 0). Add 180 for standard 0=North compass
  sunriseAzimuth = sunRises ? (sunrisePos.azimuth * 180 / Math.PI + 180) : null;

  const sunsetPos = SunCalc.getPosition(times.sunset, lat, lon);
  sunsetAzimuth = sunSets ? (sunsetPos.azimuth * 180 / Math.PI + 180) : null;

  // 2. Calculate Moon Illumination
  const moonIllumination = SunCalc.getMoonIllumination(date);
  const moonInfo = getMoonPhaseInfo(moonIllumination);
  
  // 3. Update Live Sun data (for the current moment)
  updateLiveSun(); 

  // 4. Build Twilight HTML
  const twilightData = [
    { name: "Civil", dawn: times.civilDawn, dusk: times.civilDusk },
    { name: "Nautical", dawn: times.nauticalDawn, dusk: times.nauticalDusk },
    { name: "Astronomical", dawn: times.astroDawn, dusk: times.astroDusk },
  ];

  let twilightHtml = '';
  twilightData.forEach(t => {
    const dawnTime = formatTime(t.dawn, 'twilight');
    const duskTime = formatTime(t.dusk, 'twilight');

    twilightHtml += `
      <div class="flex justify-between items-center py-2 text-sm text-gray-400 border-b border-gray-800 last:border-b-0">
        <span class="text-gray-200 font-medium w-1/3">${t.name}</span>
        <span class="text-center font-mono w-1/3">${dawnTime}</span>
        <span class="text-center font-mono w-1/3">${duskTime}</span>
      </div>
    `;
  });
  
  // 5. Build ISS Link HTML
  const issHtml = `
    <div class="p-3 text-center bg-gray-800/20 rounded-lg text-sm text-gray-400">
      <p class="mb-2 text-gray-300 font-semibold">Get real-time ISS pass predictions:</p>
      <p class="text-xs">Use the link below and input your current coordinates (Lat: ${lat_value.toFixed(3)}, Lon: ${lon_value.toFixed(3)})</p>
      <a href="https://spotthestation.nasa.gov/" target="_blank" class="text-indigo-400 hover:text-indigo-300 font-medium underline mt-2 block break-words">
        spotthestation.nasa.gov
      </a>
    </div>
  `;

  // 6. Render Results
  const resultsHtml = `
    <div class="bg-gray-900/40 border border-gray-700 rounded-xl p-4">
      <h2 class="text-2xl font-extrabold gold-text mb-4 text-center">3. Sun & Moon Calculated Data</h2>
      
      <!-- Sun Times Grid -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center border-b border-gray-700 pb-4">
        <div class="p-2 rounded-lg bg-gray-800/50">
          <div class="text-xs text-gray-400">Sunrise</div>
          <div class="text-xl font-bold">${formatTime(times.sunrise, 'sun_rise_set')}</div>
        </div>
        <div class="p-2 rounded-lg bg-gray-800/50">
          <div class="text-xs text-gray-400">Sunrise Az.</div>
          <div class="text-xl font-bold text-red-400">${sunRises ? sunriseAzimuth.toFixed(1) + 'Â°' : 'N/A'}</div>
        </div>
        <div class="p-2 rounded-lg bg-gray-800/50">
          <div class="text-xs text-gray-400">Sunset</div>
          <div class="text-xl font-bold">${formatTime(times.sunset, 'sun_rise_set')}</div>
        </div>
        <div class="p-2 rounded-lg bg-gray-800/50">
          <div class="text-xs text-gray-400">Sunset Az.</div>
          <div class="text-xl font-bold text-blue-400">${sunSets ? sunsetAzimuth.toFixed(1) + 'Â°' : 'N/A'}</div>
        </div>
      </div>

      <!-- Twilight Times -->
      <div class="mb-6 border border-gray-800 rounded-lg p-3 bg-gray-800/20">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-bold text-gray-200">Twilight Periods</h3>
            <button onclick="toggleTwilightModal(true)" class="text-gray-400 hover:text-gold-text transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0ZM8.94 6.78a.75.75 0 1 0-1.38.62c.1.28.235.566.36.85a3.75 3.75 0 0 0 6.64 1.13.75.75 0 0 0-1.42-.48a2.25 2.25 0 0 1-3.65.71L8.94 6.78ZM10 15a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div class="flex justify-between font-bold text-xs gold-text mb-1 border-b border-gray-700 pb-1">
          <span class="w-1/3">Phase</span>
          <span class="w-1/3 text-center">Dawn Starts</span>
          <span class="w-1/3 text-center">Dusk Ends</span>
        </div>
        ${twilightHtml}
      </div>

      <!-- ISS Passes Link -->
      <div class="mb-2 border border-gray-800 rounded-lg p-3 bg-gray-800/20">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-bold text-gray-200">ISS Pass Predictions</h3>
            <button onclick="toggleIssModal(true)" class="text-gray-400 hover:text-gold-text transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0ZM8.94 6.78a.75.75 0 1 0-1.38.62c.1.28.235.566.36.85a3.75 3.75 0 0 0 6.64 1.13.75.75 0 0 0-1.42-.48a2.25 2.25 0 0 1-3.65.71L8.94 6.78ZM10 15a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        ${issHtml}
      </div>


      <!-- Moon Phase -->
      <div class="text-center p-3 bg-gray-800/50 rounded-lg">
        <div class="text-xs text-gray-400 mb-1">Moon Phase</div>
        <div class="text-3xl font-bold gold-text flex items-center justify-center gap-3">
          <span class="text-4xl">${moonInfo.emoji}</span>
          ${moonInfo.name}
        </div>
        <div class="text-sm text-gray-400 mt-1">${moonInfo.fraction}% illuminated</div>
      </div>
    </div>
  `;
  document.getElementById("results").innerHTML = resultsHtml;

  // 7. Draw the compass with new data
  drawCompass();
}

/**
 * Updates the live sun azimuth and altitude in the separate live data box.
 */
function updateLiveSun() {
  if (lat_value === null || lon_value === null) {
      // Cannot calculate if location is unknown
      document.getElementById("live-sun-alt").textContent = "No location data.";
      drawCompass(); // Still draws the compass rose if possible
      return;
  }
  
  const now = new Date();
  const pos = SunCalc.getPosition(now, lat_value, lon_value);
  liveAzimuth = pos.azimuth * 180 / Math.PI + 180;
  const altitude = pos.altitude * 180 / Math.PI;

  const liveSunAltEl = document.getElementById("live-sun-alt");
  if(altitude > 0) {
     liveSunAltEl.innerHTML = `Sun is up: <span class="gold-text font-bold">${liveAzimuth.toFixed(1)}Â°</span> az $\bullet$ <span class="gold-text font-bold">${altitude.toFixed(1)}Â°</span> alt`;
  } else {
     liveSunAltEl.innerHTML = `Sun is down. Altitude: ${altitude.toFixed(1)}Â°`;
  }
 
  // Redraw frequently for live sun position and heading
  drawCompass(); 
}

/**
 * Initiates the GPS location request.
 */
function startGpsLocation() {
  const resultEl = document.getElementById("results");
  resultEl.innerHTML = `<div class="bg-gray-900/40 border border-gray-700 rounded-xl p-4 text-center text-gray-300">
      Requesting GPS location... (Check browser prompt)
    </div>`;

  navigator.geolocation.getCurrentPosition(pos => {
    // Success: Populate fields and calculate
    document.getElementById("lat").value = pos.coords.latitude.toFixed(5);
    document.getElementById("lon").value = pos.coords.longitude.toFixed(5);
    calcCelestialData();
  }, (error) => {
    // Error: Display error and prompt for manual entry (no default fallback)
    console.error("Geolocation Error:", error);
    resultEl.innerHTML = `<div class="bg-red-900/40 border border-red-700 rounded-xl p-4 text-center text-red-300">
      Location access denied or failed (${error.message}). Please enter coordinates manually and press 'Recalculate'.
    </div>`;
    document.getElementById("lat").placeholder = "Manual entry needed";
    document.getElementById("lon").placeholder = "Manual entry needed";
    document.getElementById("lat").value = ''; 
    document.getElementById("lon").value = ''; 
    lat_value = null;
    lon_value = null;
    // Attempt a compass redraw just in case, but no calculation.
    drawCompass(); 
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
}

/**
 * Initiates the device compass request.
 */
function startCompass() {
  const headingEl = document.getElementById("current-heading");
  
  const handlePermissionError = (e) => {
      console.error("Error requesting motion sensor permission:", e);
      headingEl.textContent = "Denied";
      document.getElementById("live-sun-alt").textContent = "Compass access denied.";
  };

  if (typeof DeviceOrientationEvent !== "undefined") {
    if (typeof DeviceOrientationEvent.requestPermission === "function") {
      DeviceOrientationEvent.requestPermission()
        .then(response => {
          if (response === "granted") {
            window.addEventListener("deviceorientation", handleOrientation, true);
            headingEl.textContent = "Tracking...";
          } else {
            handlePermissionError("Permission not granted by user.");
          }
        })
        .catch(handlePermissionError);
    } else {
      // For browsers that support deviceorientation but not requestPermission (Desktop/older Android)
      window.addEventListener("deviceorientationabsolute", handleOrientation, true);
      window.addEventListener("deviceorientation", handleOrientation, true);
      headingEl.textContent = "Tracking...";
    }
  } else {
    // Device doesn't support orientation events
    headingEl.textContent = "N/A";
    document.getElementById("live-sun-alt").textContent = "Device compass unavailable.";
  }
}

/**
 * Combined function called by the modal button to start both services.
 */
function requestPermissions() {
    togglePermissionModal(false); // Hide the modal
    startGpsLocation();           // Start GPS (will trigger calcCelestialData on success)
    startCompass();               // Start Compass
}

/**
 * Draws the compass rose, device heading, sunrise, sunset, and live sun position.
 */
function drawCompass() {
  const canvas = document.getElementById("compassCanvas");
  if (!canvas.getContext) return;

  const ctx = canvas.getContext("2d");
  const radius = canvas.width / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(radius, radius);
  
  // 1. Compass Ring
  ctx.beginPath();
  ctx.arc(0, 0, radius - 5, 0, 2*Math.PI);
  ctx.strokeStyle = '#ffb703';
  ctx.lineWidth = 4;
  ctx.stroke();

  // 2. Rotate the entire compass *opposite* to the smoothed heading
  ctx.rotate(-smoothHeading(heading) * Math.PI/180);

  // 3. Draw Cardinal Directions 
  ctx.font = "20px Inter";
  ctx.textAlign = "center";
  const directions = [{l:'N', d:0}, {l:'E', d:90}, {l:'S', d:180}, {l:'W', d:270}];
  
  directions.forEach(({l, d}) => {
    ctx.save();
    ctx.rotate(d * Math.PI/180);
    ctx.fillStyle = l === 'N' ? '#ffb703' : '#e0e0e0';
    ctx.fillText(l, 0, -radius + 35);
    ctx.restore();
  });
  
  // 4. Draw Azimuth Pointers (Sunrise, Sunset)
  const drawAzimuthPointer = (azimuth, color) => {
    if (azimuth !== null) {
      ctx.save();
      ctx.rotate(azimuth * Math.PI/180);
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(0, -radius + 25);
      ctx.stroke();

      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(0, -radius + 20, 5, 0, 2*Math.PI);
      ctx.fill();
      
      ctx.restore();
    }
  };

  drawAzimuthPointer(sunriseAzimuth, '#ef4444'); // Sunrise (Red)
  drawAzimuthPointer(sunsetAzimuth, '#3b82f6');  // Sunset (Blue)
  
  // 5. Draw Live Sun Position
  if (liveAzimuth !== null && lat_value !== null) {
    ctx.save();
    ctx.rotate(liveAzimuth * Math.PI/180);
    
    const sunY = -radius + 12;
    const sunR = 8;
    ctx.beginPath();
    ctx.arc(0, sunY, sunR, 0, 2*Math.PI);
    ctx.fillStyle = "#ffd700";
    ctx.fill();
    ctx.strokeStyle = "#b8860b";
    ctx.lineWidth = 1.2;
    ctx.stroke();

    ctx.restore();
  }

  ctx.restore(); 
}

/**
 * Handles device orientation events to update the compass heading.
 */
function handleOrientation(event) {
  let rawHeading = 0;
  if (event.webkitCompassHeading) {
    rawHeading = event.webkitCompassHeading;
  } else if (event.alpha !== null) {
    rawHeading = 360 - event.alpha;
  }
  
  // Update heading and redraw
  heading = rawHeading;
  document.getElementById("current-heading").textContent = `${heading.toFixed(0)}Â°`;
  
  // Update live sun position frequently
  updateLiveSun();
}

// --- Initialization ---

document.getElementById("btn-calc").addEventListener("click", calcCelestialData);

/**
 * Function to run when the page loads. Sets default date and shows permission modal.
 */
function initializeApp() {
  // 1. Set today as default date
  document.getElementById("date").value = new Date().toISOString().split("T")[0];
  
  // 2. Show the modal to request permissions (requires user click)
  togglePermissionModal(true); 
}

window.onload = initializeApp;

// Set up a timer to continuously update live sun position and compass drawing
setInterval(updateLiveSun, 3000); 
</script>
</body>
</html>

